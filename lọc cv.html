<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý CV - Nhà Tuyển Dụng</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0.8rem;
        }

        .back-btn {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            padding: 0.5rem 0.8rem;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            color: #667eea;
            text-decoration: none;
            backdrop-filter: blur(10px);
            z-index: 1000;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            font-size: 0.8rem;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 1.5rem;
            color: white;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #fff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 0.95rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 1.2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .nav-tabs {
            display: flex;
            gap: 0.4rem;
            margin-bottom: 1.2rem;
            background: linear-gradient(135deg, #f8fafc, #ffffff);
            padding: 0.4rem;
            border-radius: 25px;
            max-width: 480px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .nav-tab {
            flex: 1;
            padding: 0.8rem 1rem;
            text-align: center;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            font-size: 0.85rem;
            position: relative;
            border: 2px solid transparent;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin: 0.1rem;
        }

        .nav-tab:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            color: #667eea;
            border-color: rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            transform: translateY(-3px);
            border-color: transparent;
        }

        .nav-tab .material-symbols-outlined {
            font-size: 1rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Upload and Filter Layout - Ultra Compact */
        .upload-filter-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-bottom: 0.8rem;
        }

        .upload-section {
            margin-bottom: 0;
        }

        /* Upload Section - Ultra Compact */
        .upload-area {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px dashed #e2e8f0;
            border-radius: 16px;
            padding: 0.8rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .upload-area:hover,
        .upload-area.drag-over {
            border-color: #667eea;
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .upload-area.drag-over {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        }

        .upload-icon {
            font-size: 1.3rem;
            color: #667eea;
            margin-bottom: 0.3rem;
            transition: all 0.3s ease;
        }

        .upload-area.drag-over .upload-icon {
            color: #10b981;
            transform: scale(1.1);
        }

        .upload-area h3 {
            font-size: 0.85rem;
            margin-bottom: 0.2rem;
            color: #1a202c;
            font-weight: 600;
        }

        .upload-area p {
            color: #4a5568;
            margin-bottom: 0;
            font-size: 0.7rem;
        }

        .file-input {
            display: none;
        }

        /* Filter Section - Ultra Compact */
        .filter-section {
            background: #f8fafc;
            padding: 0.8rem;
            border-radius: 16px;
            margin-bottom: 0;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .filter-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.2rem;
            color: #2d3748;
            font-size: 0.7rem;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 0.35rem;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.7rem;
            transition: border-color 0.3s ease;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 0.6rem;
            margin-top: 0.8rem;
            justify-content: center;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
        }

        /* CV List - Ultra Compact */
        .cv-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 0.8rem;
            margin-bottom: 0.8rem;
        }

        .cv-card {
            background: white;
            border-radius: 16px;
            padding: 0.8rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .cv-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .cv-card.excellent {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.02), white);
        }

        .cv-card.good {
            border-color: #3b82f6;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.02), white);
        }

        .cv-card.average {
            border-color: #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.02), white);
        }

        .cv-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .cv-name {
            font-size: 0.9rem;
            font-weight: 700;
            color: #1a202c;
        }

        .cv-score {
            padding: 0.12rem 0.4rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.7rem;
        }

        .score-excellent {
            background: #10b981;
            color: white;
        }

        .score-good {
            background: #3b82f6;
            color: white;
        }

        .score-average {
            background: #f59e0b;
            color: white;
        }

        .score-poor {
            background: #ef4444;
            color: white;
        }

        .cv-details {
            display: grid;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .cv-detail {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.7rem;
            color: #4a5568;
        }

        .cv-detail .material-symbols-outlined {
            font-size: 0.8rem;
            color: #667eea;
        }

        .cv-actions {
            display: flex;
            gap: 0.25rem;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.65rem;
            border-radius: 16px;
        }

        /* Statistics Dashboard - Ultra Compact */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.6rem;
            margin-bottom: 0.8rem;
        }

        .stat-card {
            background: white;
            padding: 0.6rem;
            border-radius: 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 32px;
            height: 32px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.4rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-icon.excellent {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .stat-icon.good {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .stat-icon.average {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .stat-icon .material-symbols-outlined {
            color: white;
            font-size: 1rem;
        }

        .stat-info h3 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 0.1rem;
            color: #1a202c;
        }

        .stat-info p {
            color: #4a5568;
            font-weight: 500;
            margin: 0;
            font-size: 0.7rem;
        }

        .analytics-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .analytics-left,
        .analytics-right {
            background: white;
            padding: 1rem;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .top-performers h3 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: #1a202c;
        }

        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: #f8fafc;
        }
        
        /* CV Scoring Settings Styles - Ultra Compact */
        .scoring-settings-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin-top: 0.8rem;
            position: relative;
        }
        
        /* Decorative element - smaller */
        .scoring-settings-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
            border-radius: 50%;
            z-index: 0;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.1);
        }
            
        .scoring-criteria-section,
        .scoring-preview-section {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            z-index: 1;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(226, 232, 240, 0.6);
        }
        
        .scoring-criteria-section:hover,
        .scoring-preview-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.12);
        }
        
        /* Section headers with decoration - compact */
        .criteria-header,
        .preview-header {
            margin-bottom: 0.8rem;
            padding-bottom: 0.6rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .criteria-header::after,
        .preview-header::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 30px;
            height: 1px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 1px;
        }
            
        .criteria-header h3,
        .preview-header h3 {
            font-size: 1rem;
            margin: 0;
            color: #1a202c;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .criteria-header h3::before {
            content: '🎯';
            font-size: 1.1rem;
        }
        
        .preview-header h3::before {
            content: '📊';
            font-size: 1.1rem;
        }
            
        .criteria-header p {
            color: #4a5568;
            margin: 0;
            font-weight: 600;
            padding: 0.3rem 0.8rem;
            background: #f8fafc;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            font-size: 0.85rem;
        }
            
        #total-weight {
            color: #667eea;
            font-weight: 700;
            font-size: 1.1rem;
        }
            
        .criteria-form {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
        }
            
        .criteria-item {
            padding: 1rem;
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border-radius: 10px;
            border-left: 4px solid transparent;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        }
        
        .criteria-item:nth-child(1) {
            border-left-color: #3b82f6; /* Blue */
        }
        
        .criteria-item:nth-child(2) {
            border-left-color: #60a5fa; /* Light Blue */
        }
        
        .criteria-item:nth-child(3) {
            border-left-color: #34d399; /* Green */
        }
        
        .criteria-item:nth-child(4) {
            border-left-color: #10b981; /* Emerald */
        }
        
        .criteria-item:nth-child(5) {
            border-left-color: #a78bfa; /* Purple */
        }
        
        .criteria-item:nth-child(6) {
            border-left-color: #8b5cf6; /* Violet */
        }
        
        .criteria-item:nth-child(7) {
            border-left-color: #fbbf24; /* Yellow */
        }
        
        .criteria-item:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.08);
        }
            
        .criteria-item label {
            display: block;
            margin-bottom: 0.8rem;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            flex-wrap: wrap;
        }
        
        .criteria-item label small {
            margin-left: 1.2rem;
            background: #f0f4f8;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #4a5568;
        }
        
        .criteria-item label b {
            color: #667eea;
            font-weight: 700;
            font-size: 0.95rem;
        }
        
        .criteria-item:nth-child(1) label::before {
            content: '🎯';
        }
        
        .criteria-item:nth-child(2) label::before {
            content: '📝';
        }
        
        .criteria-item:nth-child(3) label::before {
            content: '💼';
        }
        
        .criteria-item:nth-child(4) label::before {
            content: '📊';
        }
        
        .criteria-item:nth-child(5) label::before {
            content: '🔧';
        }
        
        .criteria-item:nth-child(6) label::before {
            content: '🤝';
        }
        
        .criteria-item:nth-child(7) label::before {
            content: '🎓';
        }
            
        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.8rem;
            position: relative;
            background: rgba(247, 250, 252, 0.7);
            padding: 0.6rem 0.8rem;
            border-radius: 8px;
        }
        
        .slider-track {
            position: absolute;
            height: 8px;
            border-radius: 5px;
            background: #e2e8f0;
            width: 100%;
            z-index: 0;
        }
            
        .weight-slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            border-radius: 5px;
            outline: none;
            position: relative;
            z-index: 1;
        }
            
        .weight-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border: 2px solid #667eea;
        }
        
        .criteria-item:nth-child(1) .weight-slider::-webkit-slider-thumb {
            border-color: #3b82f6; /* Blue */
        }
        
        .criteria-item:nth-child(2) .weight-slider::-webkit-slider-thumb {
            border-color: #60a5fa; /* Light Blue */
        }
        
        .criteria-item:nth-child(3) .weight-slider::-webkit-slider-thumb {
            border-color: #34d399; /* Green */
        }
        
        .criteria-item:nth-child(4) .weight-slider::-webkit-slider-thumb {
            border-color: #10b981; /* Emerald */
        }
        
        .criteria-item:nth-child(5) .weight-slider::-webkit-slider-thumb {
            border-color: #a78bfa; /* Purple */
        }
        
        .criteria-item:nth-child(6) .weight-slider::-webkit-slider-thumb {
            border-color: #8b5cf6; /* Violet */
        }
        
        .criteria-item:nth-child(7) .weight-slider::-webkit-slider-thumb {
            border-color: #fbbf24; /* Yellow */
        }
            
        .weight-slider::-webkit-slider-thumb:hover {
            transform: scale(1.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        /* Firefox styles */
        .weight-slider::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border: 2px solid #667eea;
        }
        
        .weight-slider::-moz-range-thumb:hover {
            transform: scale(1.3);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
            
        .weight-value {
            font-weight: 700;
            font-size: 1rem;
            min-width: 60px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            text-align: center;
            color: white;
            background: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            position: relative;
        }
        
        .weight-value::after {
            content: '%';
            font-size: 0.95rem;
            margin-left: 2px;
        }
        
        .criteria-item:nth-child(1) .weight-value {
            background: #3b82f6; /* Blue */
        }
        
        .criteria-item:nth-child(2) .weight-value {
            background: #60a5fa; /* Light Blue */
        }
        
        .criteria-item:nth-child(3) .weight-value {
            background: #34d399; /* Green */
        }
        
        .criteria-item:nth-child(4) .weight-value {
            background: #10b981; /* Emerald */
        }
        
        .criteria-item:nth-child(5) .weight-value {
            background: #a78bfa; /* Purple */
        }
        
        .criteria-item:nth-child(6) .weight-value {
            background: #8b5cf6; /* Violet */
        }
        
        .criteria-item:nth-child(7) .weight-value {
            background: #fbbf24; /* Yellow */
        }
            
        .criteria-details {
            font-size: 0.8rem;
            color: #718096;
            padding: 0.6rem;
            background: rgba(247, 250, 252, 0.7);
            border-radius: 6px;
            margin-top: 0.5rem;
            border-left: 2px solid #e2e8f0;
        }
        
        .criteria-item:nth-child(1) .criteria-details {
            border-left-color: rgba(59, 130, 246, 0.4); /* Blue */
        }
        
        .criteria-item:nth-child(2) .criteria-details {
            border-left-color: rgba(96, 165, 250, 0.4); /* Light Blue */
        }
        
        .criteria-item:nth-child(3) .criteria-details {
            border-left-color: rgba(52, 211, 153, 0.4); /* Green */
        }
        
        .criteria-item:nth-child(4) .criteria-details {
            border-left-color: rgba(16, 185, 129, 0.4); /* Emerald */
        }
        
        .criteria-item:nth-child(5) .criteria-details {
            border-left-color: rgba(167, 139, 250, 0.4); /* Purple */
        }
        
        .criteria-item:nth-child(6) .criteria-details {
            border-left-color: rgba(139, 92, 246, 0.4); /* Violet */
        }
        
        .criteria-item:nth-child(7) .criteria-details {
            border-left-color: rgba(251, 191, 36, 0.4); /* Yellow */
        }
            
        .weight-warning {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            background: linear-gradient(135deg, #FEF2F2, #FFEDD5);
            padding: 0.8rem 1rem;
            border-radius: 8px;
            color: #9A3412;
            margin: 1rem 0;
            border-left: 3px solid #F87171;
            box-shadow: 0 2px 8px rgba(248, 113, 113, 0.1);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(248, 113, 113, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(248, 113, 113, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(248, 113, 113, 0);
            }
        }
        
        .settings-actions {
            margin-top: 1.5rem;
            display: flex;
            gap: 0.8rem;
        }
        
        .settings-actions button {
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .settings-actions button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .settings-actions .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .settings-actions .btn-secondary {
            background: #f8fafc;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }
        
        .preview-chart-container {
            height: 220px;
            margin-bottom: 1.2rem;
            position: relative;
        }
        
        .preview-chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(247, 250, 252, 0.5));
            border-radius: 16px;
            z-index: -1;
        }
            
        .preview-note {
            background: linear-gradient(135deg, #EFF6FF, #EEF2FF);
            padding: 0.8rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #1E40AF;
            margin-top: 1rem;
            border-left: 3px solid #3B82F6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }
            
        .settings-actions {
            margin-top: 2rem;
            display: flex;
            gap: 1rem;
        }
            
        .preview-chart-container {
            height: 250px;
            margin-bottom: 1.5rem;
        }
            
        .preview-note {
            background: #EFF6FF;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #1E40AF;
            margin-top: 1.5rem;
        }

        .ranking-item:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        .rank-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            margin-right: 1rem;
            font-size: 1.1rem;
        }

        .rank-1 { background: #ffd700; }
        .rank-2 { background: #c0c0c0; }
        .rank-3 { background: #cd7f32; }
        .rank-other { background: #64748b; }

        .ranking-info {
            flex: 1;
        }

        .ranking-name {
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 0.2rem;
        }

        .ranking-position {
            font-size: 0.9rem;
            color: #4a5568;
        }

        .ranking-score {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-left: 1rem;
        }

        .charts-container {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .chart-card {
            background: #f8fafc;
            padding: 0.8rem;
            border-radius: 6px;
        }

        .chart-card h3,
        .chart-card h4 {
            margin-bottom: 0.6rem;
            color: #1a202c;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .chart-card canvas {
            max-height: 140px;
        }

        /* Section headers - Ultra Compact */
        .section-header {
            margin-bottom: 0.8rem;
        }

        .section-header h2 {
            font-size: 1.1rem;
            margin-bottom: 0.3rem;
            color: #1a202c;
            font-weight: 700;
        }

        .section-header h3 {
            font-size: 1rem;
            margin-bottom: 0.3rem;
            color: #1a202c;
            font-weight: 700;
        }

        .section-header p {
            color: #4a5568;
            font-size: 0.8rem;
            margin: 0;
        }

        /* Database Stats */
        .database-stats {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-top: 0.4rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            color: #4a5568;
            font-weight: 600;
        }

        .stat-item .material-symbols-outlined {
            font-size: 1rem;
            color: #667eea;
        }

        .chart-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .chart-card {
            background: white;
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #1a202c;
        }

        /* Excel-style Ranking Table - Ultra Compact */
        .ranking-table-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
            margin-top: 1rem;
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
            line-height: 1.4;
        }

        .ranking-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.6rem 0.4rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.7rem;
            letter-spacing: 0.2px;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            position: sticky;
            top: 0;
            z-index: 10;
            text-transform: uppercase;
        }

        .ranking-table th:last-child {
            border-right: none;
        }

        .ranking-table td {
            padding: 0.5rem 0.4rem;
            border-bottom: 1px solid #e2e8f0;
            border-right: 1px solid #f1f5f9;
            vertical-align: middle;
        }

        .ranking-table td:last-child {
            border-right: none;
        }

        .ranking-table tbody tr {
            transition: all 0.2s ease;
        }

        .ranking-table tbody tr:hover {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .ranking-table tbody tr:nth-child(even) {
            background: #fafbfc;
        }

        .ranking-table tbody tr:nth-child(even):hover {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
        }

        .rank-cell {
            width: 40px;
            text-align: center;
        }

        .rank-badge {
            width: 24px;
            height: 24px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 0.7rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .rank-1 { 
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #8B4513;
        }
        .rank-2 { 
            background: linear-gradient(135deg, #C0C0C0, #A9A9A9);
            color: #2F4F4F;
        }
        .rank-3 { 
            background: linear-gradient(135deg, #CD7F32, #A0522D);
            color: white;
        }
        .rank-other { 
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
        }

        .candidate-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .candidate-avatar {
            width: 28px;
            height: 28px;
            border-radius: 10px;
            background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #475569;
            font-size: 0.75rem;
        }

        .candidate-details h4 {
            margin: 0;
            font-size: 0.8rem;
            font-weight: 600;
            color: #1e293b;
            line-height: 1.3;
        }

        .candidate-details p {
            margin: 0;
            font-size: 0.7rem;
            color: #64748b;
            line-height: 1.2;
        }

        .position-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: #f1f5f9;
            color: #475569;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            border: 1px solid #e2e8f0;
        }

        .experience-cell {
            text-align: center;
            font-weight: 500;
            color: #475569;
            font-size: 0.7rem;
        }

        .score-cell {
            text-align: center;
        }

        .score-badge {
            display: inline-block;
            padding: 0.3rem 0.6rem;
            border-radius: 16px;
            font-weight: 600;
            font-size: 0.75rem;
            min-width: 40px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .score-excellent {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .score-good {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .score-average {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .score-poor {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .actions-cell {
            text-align: center;
        }

        .action-buttons {
            display: flex;
            gap: 0.2rem;
            justify-content: center;
        }

        .action-btn {
            padding: 0.2rem 0.4rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.65rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .action-btn.secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .action-btn .material-symbols-outlined {
            font-size: 0.75rem;
        }

        /* Table responsive scroll */
        .table-scroll {
            max-height: 500px;
            overflow-y: auto;
        }

        .table-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .table-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .table-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .table-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
            color: #667eea;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Recruitment Chatbot Styles */
        .chatbot-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
            transform: translateY(100vh);
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .chatbot-container.open {
            transform: translateY(0);
        }

        .chatbot-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .chatbot-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
            animation: float 6s ease-in-out infinite;
        }

        .chatbot-title {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            font-weight: 700;
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }

        .chatbot-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        .chatbot-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .chatbot-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .chatbot-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 0.8rem;
            max-width: 85%;
            animation: slideIn 0.3s ease-out;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1rem;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .message-content {
            padding: 0.8rem 1.2rem;
            border-radius: 20px;
            font-size: 0.9rem;
            line-height: 1.5;
            position: relative;
        }
        .message.bot .message-content {
            background: white;
            border: 1px solid #e2e8f0;
            color: #2d3748;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .message.user .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .message-time {
            font-size: 0.75rem;
            opacity: 0.6;
            margin-top: 0.3rem;
            text-align: right;
        }
        .message.bot .message-time {
            text-align: left;
        }
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 1rem 0;
        }
        .typing-dots {
            display: flex;
            gap: 0.3rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: typingPulse 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.8rem;
        }

        .suggestion-chip {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suggestion-chip:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
        }

        .chatbot-input {
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            background: white;
        }

        .input-container {
            display: flex;
            gap: 0.8rem;
            align-items: flex-end;
        }

        .chatbot-textarea {
            flex: 1;
            border: 1px solid #e2e8f0;
            border-radius: 25px;
            padding: 0.8rem 1rem;
            font-size: 0.9rem;
            resize: none;
            max-height: 80px;
            min-height: 40px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .chatbot-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-button {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .chatbot-toggle {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            z-index: 999;
            font-size: 1.3rem;
        }

        .chatbot-toggle:hover {
            transform: scale(1.08);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .notification-badge {
            position: absolute;
            top: -3px;
            right: -3px;
            width: 16px;
            height: 16px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            animation: bounceIn 0.5s ease;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes typingPulse {
            0%, 60%, 100% { 
                transform: scale(1); 
                opacity: 0.4; 
            }
            30% { 
                transform: scale(1.2); 
                opacity: 1; 
            }
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes slideInRight {
            from { 
                opacity: 0; 
                transform: translateX(100%); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        /* Mobile responsiveness - Ultra Compact */
        @media (max-width: 768px) {
            .container {
                padding: 0.6rem;
            }

            .header h1 {
                font-size: 1.6rem;
            }

            .header p {
                font-size: 0.8rem;
            }

            .main-content {
                padding: 1rem;
                border-radius: 16px;
            }

            .nav-tabs {
                flex-direction: column;
                gap: 0.2rem;
                max-width: 100%;
            }

            .nav-tab {
                padding: 0.6rem 0.8rem;
                font-size: 0.75rem;
            }

            .upload-filter-container {
                grid-template-columns: 1fr;
                gap: 0.6rem;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .cv-grid {
                grid-template-columns: 1fr;
            }

            .analytics-content {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.6rem;
            }

            .ranking-table-container {
                overflow-x: auto;
            }

            .ranking-table {
                min-width: 500px;
            }

            .ranking-table th,
            .ranking-table td {
                padding: 0.4rem 0.3rem;
                font-size: 0.65rem;
            }

            .candidate-info {
                gap: 0.3rem;
            }

            .candidate-avatar {
                width: 24px;
                height: 24px;
                font-size: 0.65rem;
            }

            .candidate-details h4 {
                font-size: 0.75rem;
            }

            .candidate-details p {
                font-size: 0.6rem;
            }

            .action-buttons {
                flex-direction: column;
                gap: 0.15rem;
            }

            .action-btn {
                padding: 0.15rem 0.3rem;
                font-size: 0.6rem;
            }

            .chatbot-container {
                width: calc(100vw - 1rem);
                height: calc(100vh - 2rem);
                bottom: 0.5rem;
                right: 0.5rem;
                left: 0.5rem;
                border-radius: 20px;
            }

            .chatbot-toggle {
                bottom: 0.8rem;
                right: 0.8rem;
                width: 45px;
                height: 45px;
                font-size: 1.2rem;
            }

            /* Mobile - Compact Settings */
            .scoring-settings-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .scoring-criteria-section,
            .scoring-preview-section {
                padding: 0.8rem;
            }

            .criteria-form {
                gap: 1rem;
            }

            .criteria-item {
                padding: 0.8rem;
            }

            .criteria-item label {
                font-size: 0.85rem;
                gap: 0.3rem;
            }

            .criteria-item label small {
                margin-left: 0.8rem;
                font-size: 0.75rem;
            }

            .slider-container {
                gap: 0.8rem;
                padding: 0.5rem 0.6rem;
            }

            .weight-value {
                min-width: 50px;
                height: 28px;
                font-size: 0.85rem;
            }

            .criteria-details {
                font-size: 0.75rem;
                padding: 0.5rem;
            }

            .settings-actions {
                flex-direction: column;
                gap: 0.6rem;
            }

            .settings-actions button {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }

            .preview-chart-container {
                height: 180px;
            }

            .preview-note {
                font-size: 0.75rem;
                padding: 0.6rem 0.8rem;
            }
        }

        /* Tablet responsiveness */
        @media (max-width: 1024px) and (min-width: 769px) {
            .container {
                padding: 1rem;
            }

            .analytics-content {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <a href="../../giao diện chính/index.html" class="back-btn">
        <span class="material-symbols-outlined">arrow_back</span>
        Quay lại
    </a>

    <div class="container">
        <div class="header">
            <h1>🏢 Hệ Thống Quản Lý CV</h1>
            <p>Quản lý, lọc và đánh giá ứng viên hiệu quả với AI</p>
        </div>

        <div class="main-content">
            <div class="nav-tabs">
                <div class="nav-tab active" data-tab="management">
                    <span class="material-symbols-outlined">folder_managed</span>
                    Quản Lý CV
                </div>
                <div class="nav-tab" data-tab="analytics">
                    <span class="material-symbols-outlined">analytics</span>
                    Bảng Phân Tích
                </div>
                <div class="nav-tab" data-tab="settings">
                    <span class="material-symbols-outlined">tune</span>
                    Tùy Chỉnh Tiêu Chí
                </div>
            </div>

            <!-- CV Management Tab (Combined Upload + Manage) -->
            <div class="tab-content active" id="management-tab">
                <!-- Upload and Filter Container -->
                <div class="upload-filter-container">
                    <!-- Quick Upload Section -->
                    <div class="upload-section">
                        <div class="section-header">
                            <h2 style="font-size: 1rem; margin-bottom: 0.3rem; color: #1a202c;">📁 Tải Lên CV</h2>
                            <p style="font-size: 0.75rem; color: #64748b; margin: 0;">Kéo thả hoặc click để chọn file</p>
                        </div>
                        
                        <div class="upload-area" id="upload-area">
                            <div class="upload-icon">
                                <span class="material-symbols-outlined">cloud_upload</span>
                            </div>
                            <h3>Thả file CV vào đây</h3>
                            <p>PDF, DOC, DOCX, JPG, PNG (Max 10MB)</p>
                            <input type="file" id="cv-files" class="file-input" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                        </div>

                        <div id="upload-progress" style="display: none;">
                            <div style="background: #e2e8f0; border-radius: 10px; height: 8px; margin: 1rem 0;">
                                <div id="progress-bar" style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; border-radius: 10px; width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                            <p id="upload-status">Đang xử lý file...</p>
                        </div>

                        <div id="upload-results" style="display: none;">
                            <h4 style="margin-bottom: 0.8rem; font-size: 1rem;">Kết Quả:</h4>
                            <div id="results-list"></div>
                        </div>
                    </div>

                    <!-- Advanced Filters & Search -->
                    <div class="filter-section">
                        <div class="section-header">
                            <h2 style="font-size: 1rem; margin-bottom: 0.3rem; color: #1a202c;">🔍 Bộ Lọc & Tìm Kiếm</h2>
                            <p style="font-size: 0.75rem; color: #64748b; margin: 0;">Lọc trong cơ sở dữ liệu CV</p>
                        </div>
                        
                        <div class="filter-grid">
                            <div class="filter-group">
                                <label>Vị Trí</label>
                                <select id="filter-position">
                                    <option value="">Tất cả vị trí</option>
                                    <option value="frontend">Frontend Developer</option>
                                    <option value="backend">Backend Developer</option>
                                    <option value="fullstack">Fullstack Developer</option>
                                    <option value="mobile">Mobile Developer</option>
                                    <option value="data">Data Scientist</option>
                                    <option value="design">UI/UX Designer</option>
                                    <option value="marketing">Marketing</option>
                                    <option value="other">Khác</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Kinh Nghiệm</label>
                                <select id="filter-experience">
                                    <option value="">Tất cả cấp độ</option>
                                    <option value="0-1">Fresher (0-1 năm)</option>
                                    <option value="1-3">Junior (1-3 năm)</option>
                                    <option value="3-5">Middle (3-5 năm)</option>
                                    <option value="5+">Senior (5+ năm)</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Điểm CV</label>
                                <select id="filter-score">
                                    <option value="">Tất cả điểm</option>
                                    <option value="90-100">Xuất sắc (90-100)</option>
                                    <option value="80-89">Tốt (80-89)</option>
                                    <option value="70-79">Khá (70-79)</option>
                                    <option value="0-69">Cần cải thiện (<70)</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Từ Khóa</label>
                                <input type="text" id="search-keyword" placeholder="Tên, kỹ năng, công ty...">
                            </div>
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" id="apply-filters">
                                <span class="material-symbols-outlined">search</span>
                                Áp Dụng
                            </button>
                            <button class="btn btn-secondary" id="reset-filters">
                                <span class="material-symbols-outlined">refresh</span>
                                Đặt Lại
                            </button>
                        </div>
                    </div>
                </div>

                <!-- CV Database Grid -->
                <div class="cv-database-section">
                    <div class="section-header">
                        <h2 style="font-size: 1.1rem; margin-bottom: 0.5rem; color: #1a202c;">Kết Quả Lọc CV</h2>
                        <div class="database-stats" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <span class="stat-item" style="display: flex; align-items: center; gap: 0.3rem; font-size: 0.75rem; color: #64748b;">
                                <span class="material-symbols-outlined" style="font-size: 1rem; color: #667eea;">folder</span>
                                <span id="total-cvs">0</span> Tổng CV
                            </span>
                            <span class="stat-item" style="display: flex; align-items: center; gap: 0.3rem; font-size: 0.75rem; color: #64748b;">
                                <span class="material-symbols-outlined" style="font-size: 1rem; color: #10b981;">star</span>
                                <span id="excellent-cvs">0</span> Xuất sắc
                            </span>
                            <span class="stat-item" style="display: flex; align-items: center; gap: 0.3rem; font-size: 0.75rem; color: #64748b;">
                                <span class="material-symbols-outlined" style="font-size: 1rem; color: #3b82f6;">trending_up</span>
                                <span id="good-cvs">0</span> Tốt
                            </span>
                        </div>
                    </div>
                    
                    <div class="cv-grid" id="cv-grid">
                        <!-- CV cards will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Analytics Dashboard Tab (Combined Ranking + Statistics) -->
            <div class="tab-content" id="analytics-tab">
                <!-- Performance Overview -->
                <div class="analytics-overview">
                    <div class="section-header">
                        <h2 style="font-size: 1.2rem; margin-bottom: 0.5rem; color: #1a202c;">📈 Tổng Quan Hiệu Suất</h2>
                        <p style="font-size: 0.8rem; color: #64748b; margin: 0;">Các chỉ số và thông tin chi tiết từ cơ sở dữ liệu CV của bạn</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <span class="material-symbols-outlined">folder</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-total">0</h3>
                                <p>Tổng CV</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon excellent">
                                <span class="material-symbols-outlined">star</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-excellent">0</h3>
                                <p>CV Xuất sắc</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon good">
                                <span class="material-symbols-outlined">trending_up</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-good">0</h3>
                                <p>CV Tốt</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon average">
                                <span class="material-symbols-outlined">analytics</span>
                            </div>
                            <div class="stat-info">
                                <h3 id="stat-average">0</h3>
                                <p>Điểm Trung Bình</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Performers & Charts -->
                <div class="analytics-content">
                    <div class="analytics-left">
                        <div class="top-performers">
                            <div class="section-header">
                                <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; color: #1a202c;">🏆 Bảng Xếp Hạng CV</h3>
                                <p style="font-size: 0.8rem; color: #64748b; margin: 0;">Ranking ứng viên theo điểm đánh giá tổng thể</p>
                            </div>
                            
                            <!-- Excel-style Table -->
                            <div class="ranking-table-container">
                                <div class="table-scroll">
                                    <table class="ranking-table" id="ranking-table">
                                        <thead>
                                            <tr>
                                                <th class="rank-cell">Hạng</th>
                                                <th>Ứng Viên</th>
                                                <th>Vị Trí</th>
                                                <th>Kinh Nghiệm</th>
                                                <th>Điểm CV</th>
                                                <th>Thao Tác</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ranking-tbody">
                                            <!-- Ranking data will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-right">
                        <div class="charts-container">
                            <div class="chart-card">
                                <h3>Score Distribution</h3>
                                <canvas id="scoreChart"></canvas>
                            </div>
                            <div class="chart-card">
                                <h3>Position Distribution</h3>
                                <canvas id="positionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- CV Scoring Settings Tab -->
            <div class="tab-content" id="settings-tab">
                <div class="section-header">
                    <h2 style="font-size: 1.2rem; margin-bottom: 0.4rem; color: #1a202c;">⚙️ Tùy Chỉnh Tiêu Chí Đánh Giá CV</h2>
                    <p style="font-size: 0.85rem; color: #64748b; margin: 0;">Điều chỉnh trọng số đánh giá CV theo nhu cầu tuyển dụng</p>
                </div>

                <div class="scoring-settings-container">
                    <div class="scoring-criteria-section">
                        <div class="criteria-header">
                            <h3>Tiêu Chí Đánh Giá</h3>
                            <p>Tổng điểm: <span id="total-weight">100</span>%</p>
                        </div>
                        
                        <!-- Industry Template Selector -->
                        <div class="template-selector" style="margin-bottom: 1rem; padding: 0.8rem; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 8px; border: 1px solid #bae6fd;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.6rem;">
                                <span style="font-size: 1.1rem;">🎯</span>
                                <h4 style="font-size: 0.9rem; font-weight: 600; color: #0c4a6e; margin: 0;">Mẫu Tiêu Chí Theo Ngành</h4>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.6rem; align-items: end;">
                                <div>
                                    <label for="industry-template" style="display: block; font-size: 0.75rem; font-weight: 600; color: #0f172a; margin-bottom: 0.3rem;">Chọn ngành nghề:</label>
                                    <select id="industry-template" style="width: 100%; padding: 0.4rem 0.6rem; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.8rem; background: white;">
                                        <option value="">-- Tùy chỉnh thủ công --</option>
                                        <option value="it-software">🖥️ Công Nghệ Thông Tin / Phần Mềm</option>
                                        <option value="marketing-sales">📈 Marketing / Bán Hàng</option>
                                        <option value="finance-accounting">💰 Tài Chính / Kế Toán</option>
                                        <option value="human-resources">👥 Nhân Sự / Tuyển Dụng</option>
                                        <option value="design-creative">🎨 Thiết Kế / Sáng Tạo</option>
                                        <option value="engineering-manufacturing">⚙️ Kỹ Thuật / Sản Xuất</option>
                                        <option value="healthcare-medical">🏥 Y Tế / Chăm Sóc Sức Khỏe</option>
                                        <option value="education-training">📚 Giáo Dục / Đào Tạo</option>
                                    </select>
                                </div>
                                <button type="button" onclick="applyIndustryTemplate()" style="padding: 0.4rem 0.8rem; background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; border: none; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                    Áp Dụng
                                </button>
                            </div>
                            <p style="font-size: 0.7rem; color: #475569; margin: 0.4rem 0 0 0; font-style: italic;">💡 Chọn ngành nghề để tự động điều chỉnh trọng số phù hợp</p>
                        </div>
                        
                        <div class="criteria-form">
                            <div class="criteria-item">
                                <label for="job-relevance-weight">Mức độ Phù hợp với Vị trí <small>(Trọng số hiện tại: <b id="job-relevance-percent">25%</b>)</small></label>
                                <div class="slider-container">
                                    <div class="slider-track"></div>
                                    <input type="range" min="5" max="50" value="25" class="weight-slider" id="job-relevance-weight">
                                    <span class="weight-value" id="job-relevance-value">25</span>
                                </div>
                                <div class="criteria-details">
                                    <p>Đánh giá mức độ phù hợp của kỹ năng, kinh nghiệm với yêu cầu cụ thể của vị trí (điểm cao nhất cho sự khớp với JD)</p>
                                </div>
                            </div>

                            <div class="criteria-item">
                                <label for="professionalism-weight">Chuyên Nghiệp & Rõ Ràng <small>(Trọng số hiện tại: <b id="professionalism-percent">15%</b>)</small></label>
                                <div class="slider-container">
                                    <div class="slider-track"></div>
                                    <input type="range" min="5" max="50" value="15" class="weight-slider" id="professionalism-weight">
                                    <span class="weight-value" id="professionalism-value">15</span>
                                </div>
                                <div class="criteria-details">
                                    <p>Đánh giá email, số điện thoại, họ tên đầy đủ, cấu trúc CV và mức độ chi tiết của CV</p>
                                </div>
                            </div>
                            <div class="criteria-item">
                                <label for="experience-weight">Kinh Nghiệm Làm Việc <small>(Trọng số hiện tại: <b id="experience-percent">20%</b>)</small></label>
                                <div class="slider-container">
                                    <div class="slider-track"></div>
                                    <input type="range" min="5" max="50" value="20" class="weight-slider" id="experience-weight">
                                    <span class="weight-value" id="experience-value">20</span>
                                </div>
                                <div class="criteria-details">
                                    <p>Đánh giá số lượng và chất lượng kinh nghiệm làm việc dựa trên thời gian và vị trí</p>
                                </div>
                            </div>

                            <div class="criteria-item">
                                <label for="achievements-weight">Thành tựu & Kết quả <small>(Trọng số hiện tại: <b id="achievements-percent">15%</b>)</small></label>
                                <div class="slider-container">
                                    <div class="slider-track"></div>
                                    <input type="range" min="5" max="50" value="15" class="weight-slider" id="achievements-weight">
                                    <span class="weight-value" id="achievements-value">15</span>
                                </div>
                                <div class="criteria-details">
                                    <p>Đánh giá thành tựu cụ thể với con số/phần trăm, chứng minh hiệu quả làm việc (ví dụ: tăng doanh số 20%, giảm chi phí 15%)</p>
                                </div>
                            </div>

                            <div class="criteria-item">
                                <label for="skills-weight">Kỹ Năng Chuyên Môn <small>(Trọng số hiện tại: <b id="skills-percent">15%</b>)</small></label>
                                <div class="slider-container">
                                    <div class="slider-track"></div>
                                    <input type="range" min="5" max="50" value="15" class="weight-slider" id="skills-weight">
                                    <span class="weight-value" id="skills-value">15</span>
                                </div>
                                <div class="criteria-details">
                                    <p>Đánh giá số lượng kỹ năng liên quan, công nghệ và công cụ mà ứng viên thành thạo</p>
                                </div>
                            </div>

                            <div class="criteria-item">
                                <label for="soft-skills-weight">Kỹ năng mềm / Phẩm chất cá nhân <small>(Trọng số hiện tại: <b id="soft-skills-percent">5%</b>)</small></label>
                                <div class="slider-container">
                                    <div class="slider-track"></div>
                                    <input type="range" min="5" max="30" value="5" class="weight-slider" id="soft-skills-weight">
                                    <span class="weight-value" id="soft-skills-value">5</span>
                                </div>
                                <div class="criteria-details">
                                    <p>Đánh giá kỹ năng mềm như làm việc nhóm, lãnh đạo, giao tiếp, thích nghi, và các hoạt động thể hiện phẩm chất cá nhân</p>
                                </div>
                            </div>

                            <div class="criteria-item">
                                <label for="education-weight">Học Vấn <small>(Trọng số hiện tại: <b id="education-percent">5%</b>)</small></label>
                                <div class="slider-container">
                                    <div class="slider-track"></div>
                                    <input type="range" min="5" max="30" value="5" class="weight-slider" id="education-weight">
                                    <span class="weight-value" id="education-value">5</span>
                                </div>
                                <div class="criteria-details">
                                    <p>Đánh giá bằng cấp, chi tiết học vấn, thành tích học tập và trình độ đại học/cao học</p>
                                </div>
                            </div>
                        </div>

                        <div class="weight-warning" id="weight-warning" style="display: none;">
                            <span class="material-symbols-outlined">warning</span>
                            <p>Tổng điểm phân bổ phải bằng 100% để đảm bảo đánh giá chính xác!</p>
                        </div>

                        <div class="settings-actions">
                            <button class="btn btn-primary" id="save-weights">
                                <span class="material-symbols-outlined">save</span>
                                Lưu Thiết Lập
                            </button>
                            <button class="btn btn-secondary" id="reset-default-weights">
                                <span class="material-symbols-outlined">refresh</span>
                                Khôi Phục Mặc Định
                            </button>
                        </div>
                    </div>

                    <div class="scoring-preview-section">
                        <div class="preview-header">
                            <h3>Xem Trước</h3>
                            <p>Phân bổ mới</p>
                        </div>
                        
                        <div class="preview-chart-container">
                            <canvas id="weightChart"></canvas>
                        </div>
                        
                        <div class="preview-note">
                            <p><strong>Lưu ý:</strong> Thay đổi trọng số sẽ ảnh hưởng đến tất cả CV trong hệ thống. Điều chỉnh phù hợp sẽ giúp tìm ứng viên phù hợp hơn.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing data...</p>
            </div>
        </div>
    </div>
    <!-- AI Recruitment Advisor Chatbot -->
    <button class="chatbot-toggle" id="chatbotToggle">
        🤖
        <div class="notification-badge" id="notificationBadge" style="display: none;">1</div>
    </button>

    <div class="chatbot-container" id="chatbotContainer">
        <div class="chatbot-header">
            <div class="chatbot-title">
                <span>🎯</span>
                <div>
                    <div>AI Tư Vấn Tuyển Dụng</div>
                    <div class="chatbot-status">
                        <div class="status-dot"></div>
                        <span>Trực tuyến</span>
                    </div>
                </div>
            </div>
            <button class="chatbot-close" id="chatbotClose">×</button>
        </div>

        <div class="chatbot-messages" id="chatbotMessages">
            <div class="message bot">
                <div class="message-avatar">🤖</div>
                <div>
                    <div class="message-content">
                        Xin chào! Tôi là AI Tư Vấn Tuyển Dụng của Tech CV. Tôi có thể giúp bạn:
                        
                        • Phân tích dữ liệu CV trong hệ thống
                        • Đề xuất câu hỏi phỏng vấn phù hợp
                        • Tư vấn chiến lược tuyển dụng
                        • So sánh mức lương thị trường
                        • Đưa ra quyết định tuyển dụng tối ưu
                        
                        Bạn cần hỗ trợ gì hôm nay?
                    </div>
                    <div class="suggestion-chips">
                        <div class="suggestion-chip" data-suggestion="Phân tích dữ liệu CV hiện tại">📊 Phân tích dữ liệu CV</div>
                        <div class="suggestion-chip" data-suggestion="Top ứng viên xuất sắc nhất">🏆 Top ứng viên</div>
                        <div class="suggestion-chip" data-suggestion="Thống kê CV theo vị trí">📈 Thống kê vị trí</div>
                    </div>
                    <div class="message-time">Vừa xong</div>
                </div>
            </div>
        </div>

        <div class="chatbot-input">
            <div class="input-container">
                <textarea class="chatbot-textarea" id="chatbotInput" placeholder="Nhập câu hỏi của bạn..." rows="1"></textarea>
                <button class="send-button" id="sendButton">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Configuration
        const GEMINI_API_KEY = 'AIzaSyBS_x_yc-j7yBoCksqiET3TlZZDPgVnrWU';
        const GEMINI_MODEL = 'gemini-1.5-flash-latest';
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

        // Global variables
        let cvDatabase = [];
        let filteredCVs = [];
        let charts = {};

        // Mẫu tiêu chí đánh giá theo ngành nghề
        const industryTemplates = {
            'it-software': {
                name: 'Công Nghệ Thông Tin / Phần Mềm',
                criteria: {
                    'job-relevance': 30,    // Kỹ năng lập trình, frameworks
                    'professionalism': 10,  // CV chuyên nghiệp
                    'experience': 25,       // Kinh nghiệm dự án
                    'achievements': 15,     // Sản phẩm, đóng góp code
                    'skills': 15,           // Technical skills
                    'soft-skills': 3,       // Teamwork, communication
                    'education': 2          // Bằng cấp IT
                }
            },
            'marketing-sales': {
                name: 'Marketing / Bán Hàng',
                criteria: {
                    'job-relevance': 25,    // Kinh nghiệm marketing/sales
                    'professionalism': 15,  // Presentation skills
                    'experience': 20,       // Track record bán hàng
                    'achievements': 25,     // KPI, doanh số cụ thể
                    'skills': 8,            // Tools: Google Analytics, CRM
                    'soft-skills': 5,       // Communication, persuasion
                    'education': 2          // Marketing/Business degree
                }
            },
            'finance-accounting': {
                name: 'Tài Chính / Kế Toán',
                criteria: {
                    'job-relevance': 25,    // Kinh nghiệm tài chính
                    'professionalism': 20,  // Tính chính xác, chi tiết
                    'experience': 20,       // Kinh nghiệm ngành
                    'achievements': 10,     // Tiết kiệm chi phí, tối ưu
                    'skills': 10,           // Excel, SAP, accounting software
                    'soft-skills': 5,       // Analytical thinking
                    'education': 10         // Bằng cấp tài chính/kế toán
                }
            },
            'human-resources': {
                name: 'Nhân Sự / Tuyển Dụng',
                criteria: {
                    'job-relevance': 25,    // Kinh nghiệm HR
                    'professionalism': 15,  // Kỹ năng giao tiếp
                    'experience': 20,       // Kinh nghiệm quản lý nhân sự
                    'achievements': 15,     // Tỷ lệ tuyển dụng thành công
                    'skills': 8,            // HR tools, recruitment platforms
                    'soft-skills': 12,      // Leadership, empathy
                    'education': 5          // Psychology, HR degree
                }
            },
            'design-creative': {
                name: 'Thiết Kế / Sáng Tạo',
                criteria: {
                    'job-relevance': 25,    // Portfolio, design experience
                    'professionalism': 10,  // Presentation của CV
                    'experience': 20,       // Kinh nghiệm thiết kế
                    'achievements': 25,     // Awards, featured projects
                    'skills': 15,           // Design software, tools
                    'soft-skills': 3,       // Creativity, collaboration
                    'education': 2          // Design/Art degree
                }
            },
            'engineering-manufacturing': {
                name: 'Kỹ Thuật / Sản Xuất',
                criteria: {
                    'job-relevance': 30,    // Kinh nghiệm kỹ thuật
                    'professionalism': 15,  // Technical documentation
                    'experience': 25,       // Kinh nghiệm ngành
                    'achievements': 10,     // Process improvement
                    'skills': 12,           // CAD, technical tools
                    'soft-skills': 3,       // Problem-solving
                    'education': 5          // Engineering degree
                }
            },
            'healthcare-medical': {
                name: 'Y Tế / Chăm Sóc Sức Khỏe',
                criteria: {
                    'job-relevance': 20,    // Kinh nghiệm y tế
                    'professionalism': 20,  // Tính chuyên nghiệp cao
                    'experience': 25,       // Kinh nghiệm lâm sàng
                    'achievements': 8,      // Nghiên cứu, bài báo
                    'skills': 7,            // Medical equipment, software
                    'soft-skills': 10,      // Empathy, communication
                    'education': 10         // Medical degree, certifications
                }
            },
            'education-training': {
                name: 'Giáo Dục / Đào Tạo',
                criteria: {
                    'job-relevance': 25,    // Kinh nghiệm giảng dạy
                    'professionalism': 15,  // Kỹ năng truyền đạt
                    'experience': 20,       // Kinh nghiệm giáo dục
                    'achievements': 15,     // Thành tích học sinh
                    'skills': 8,            // Teaching tools, LMS
                    'soft-skills': 12,      // Patience, communication
                    'education': 5          // Education degree
                }
            }
        };

        // CV Parsing Function using Gemini API
        async function parseCvUsingGemini(cvText) {
            // 1. Preprocess cvText: normalize whitespace and line breaks, ensure UTF-8 encoding
            const preprocessedText = cvText
                .replace(/\s+/g, ' ')  // normalize multiple spaces/tabs to single space
                .replace(/\n+/g, '\n') // normalize multiple line breaks to single line break
                .trim();

            // 2. Build Gemini API request with temperature=0 and strict JSON schema
            const prompt = `Analyze the following CV text and extract information in the exact JSON format specified below.

IMPORTANT: Return ONLY the JSON object, no additional text or explanation.

Example output format:
{
  "full_name": "Nguyễn Văn A",
  "email": "nguyenvana@email.com",
  "phone": "0123456789",
  "education": [
    { "degree": "Cử nhân Công nghệ Thông tin", "school": "Đại học Bách Khoa Hà Nội", "year_range": "2018-2022" }
  ],
  "work_experience": [
    { "position": "Frontend Developer", "company": "FPT Software", "year_range": "2022-2024" }
  ]
}

CV Text to analyze:
${preprocessedText}

Extract the following information:
- full_name: Person's full name (string or null if not found)
- email: Email address (string or null if not found)
- phone: Phone number in Vietnamese format (string or null if not found)
- education: Array of education entries with degree, school, year_range (empty array if none found)
- work_experience: Array of work experience with position, company, year_range (empty array if none found)

Return the JSON object now:`;

            const requestBody = {
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }],
                generationConfig: {
                    temperature: 0,
                    maxOutputTokens: 1024
                }
            };

            try {
                // 3. Send the request and await response
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Invalid API response structure');
                }

                const responseText = data.candidates[0].content.parts[0].text.trim();
                
                // Try to extract JSON from response (in case there's extra text)
                let jsonMatch = responseText.match(/\{[\s\S]*\}/);
                let jsonText = jsonMatch ? jsonMatch[0] : responseText;
                
                // Parse the JSON response
                let parsedData;
                try {
                    parsedData = JSON.parse(jsonText);
                } catch (parseError) {
                    throw new Error(`Failed to parse JSON response: ${parseError.message}`);
                }

                // 4. Fallback regex extraction for missing fields
                let result = {
                    full_name: parsedData.full_name || null,
                    email: parsedData.email || null,
                    phone: parsedData.phone || null,
                    education: Array.isArray(parsedData.education) ? parsedData.education : [],
                    work_experience: Array.isArray(parsedData.work_experience) ? parsedData.work_experience : []
                };

                // Fallback regex for email if missing
                if (!result.email) {
                    const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-z]{2,}/;
                    const emailMatch = preprocessedText.match(emailRegex);
                    if (emailMatch) {
                        result.email = emailMatch[0];
                    }
                }

                // Fallback regex for phone (Vietnamese format) if missing
                if (!result.phone) {
                    const phoneRegex = /\b0\d{9,10}\b/;
                    const phoneMatch = preprocessedText.match(phoneRegex);
                    if (phoneMatch) {
                        result.phone = phoneMatch[0];
                    }
                }

                // 5. Return the parsed object
                return result;

            } catch (error) {
                // If API call fails or JSON is invalid, return object with null/empty values
                return {
                    full_name: null,
                    email: null,
                    phone: null,
                    education: [],
                    work_experience: []
                };
            }
        }

        // Industry Template Functions
        function applyIndustryTemplate() {
            const selectedTemplate = document.getElementById('industry-template').value;
            
            if (!selectedTemplate) {
                alert('⚠️ Vui lòng chọn một ngành nghề từ danh sách');
                return;
            }

            const template = industryTemplates[selectedTemplate];
            if (!template) {
                alert('❌ Không tìm thấy mẫu tiêu chí cho ngành này');
                return;
            }

            // Apply template weights to sliders
            const criteria = template.criteria;
            
            // Update each slider and its display
            Object.keys(criteria).forEach(key => {
                const weight = criteria[key];
                const slider = document.getElementById(key + '-weight');
                const valueDisplay = document.getElementById(key + '-value');
                const percentDisplay = document.getElementById(key + '-percent');
                
                if (slider && valueDisplay && percentDisplay) {
                    slider.value = weight;
                    valueDisplay.textContent = weight;
                    percentDisplay.textContent = weight + '%';
                }
            });

            // Update total weight
            updateTotalWeight();
            
            // Show success message
            const templateName = template.name;
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                z-index: 10000;
                font-weight: 600;
                font-size: 0.9rem;
                animation: slideInRight 0.3s ease;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span>✅</span>
                    <span>Đã áp dụng mẫu tiêu chí: ${templateName}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove notification after 3 seconds
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function updateTotalWeight() {
            const sliders = document.querySelectorAll('.weight-slider');
            let total = 0;
            
            sliders.forEach(slider => {
                total += parseInt(slider.value) || 0;
            });
            
            const totalWeightElement = document.getElementById('total-weight');
            if (totalWeightElement) {
                totalWeightElement.textContent = total;
                totalWeightElement.style.color = total === 100 ? '#10b981' : '#ef4444';
            }
            
            // Show/hide warning
            const warning = document.getElementById('weight-warning');
            if (warning) {
                warning.style.display = total !== 100 ? 'flex' : 'none';
            }
        }

        // DOM Elements
        const navTabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const uploadArea = document.getElementById('upload-area');
        const cvFiles = document.getElementById('cv-files');
        const uploadProgress = document.getElementById('upload-progress');
        const progressBar = document.getElementById('progress-bar');
        const uploadStatus = document.getElementById('upload-status');
        const uploadResults = document.getElementById('upload-results');
        const resultsList = document.getElementById('results-list');
        const cvGrid = document.getElementById('cv-grid');
        const rankingList = document.getElementById('ranking-list');
        const loading = document.getElementById('loading');

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            createDemoData(); // Tạo dữ liệu demo
        });

        function createDemoData() {
            // Tạo một số CV demo để test
            const demoCVs = [
                {
                    id: 'demo-1',
                    filename: 'nguyen_van_a_frontend.pdf',
                    full_name: 'Nguyễn Văn A',
                    email: 'nguyenvana@email.com',
                    phone: '0123456789',
                    position: 'Frontend Developer',
                    experience: '3 năm',
                    education: [
                        { degree: 'Cử nhân Công nghệ Thông tin', school: 'Đại học Bách Khoa Hà Nội', year_range: '2018-2022' }
                    ],
                    work_experience: [
                        { position: 'Frontend Developer', company: 'FPT Software', year_range: '2022-2024' },
                        { position: 'Intern Developer', company: 'VNG Corporation', year_range: '2021-2022' }
                    ],
                    skills: ['React', 'Vue.js', 'JavaScript', 'CSS', 'HTML'],
                    score: 85,
                    uploadDate: new Date('2024-12-01')
                },
                {
                    id: 'demo-2',
                    filename: 'tran_thi_b_marketing.pdf',
                    full_name: 'Trần Thị B',
                    email: 'tranthib@email.com',
                    phone: '0987654321',
                    position: 'Marketing Manager',
                    experience: '5 năm',
                    education: [
                        { degree: 'Cử nhân Quản trị Kinh doanh', school: 'Đại học Ngoại Thương', year_range: '2016-2020' }
                    ],
                    work_experience: [
                        { position: 'Marketing Manager', company: 'Shopee Vietnam', year_range: '2022-2024' },
                        { position: 'Digital Marketing Specialist', company: 'Lazada', year_range: '2020-2022' }
                    ],
                    skills: ['Google Analytics', 'Facebook Ads', 'SEO', 'Content Marketing'],
                    score: 92,
                    uploadDate: new Date('2024-12-02')
                },
                {
                    id: 'demo-3',
                    filename: 'le_van_c_design.pdf',
                    full_name: 'Lê Văn C',
                    email: 'levanc@email.com',
                    phone: '0369258147',
                    position: 'UI/UX Designer',
                    experience: '2 năm',
                    education: [
                        { degree: 'Cử nhân Thiết kế Đồ họa', school: 'Đại học Mỹ thuật Công nghiệp', year_range: '2019-2023' }
                    ],
                    work_experience: [
                        { position: 'UI/UX Designer', company: 'Tiki', year_range: '2023-2024' }
                    ],
                    skills: ['Figma', 'Adobe XD', 'Photoshop', 'Illustrator', 'Prototyping'],
                    score: 76,
                    uploadDate: new Date('2024-12-03')
                },
                {
                    id: 'demo-4',
                    filename: 'pham_thi_d_hr.pdf',
                    full_name: 'Phạm Thị D',
                    email: 'phamthid@email.com',
                    phone: '0456789123',
                    position: 'HR Specialist',
                    experience: '4 năm',
                    education: [
                        { degree: 'Cử nhân Tâm lý học', school: 'Đại học Sư phạm Hà Nội', year_range: '2017-2021' }
                    ],
                    work_experience: [
                        { position: 'HR Specialist', company: 'Samsung Vietnam', year_range: '2021-2024' }
                    ],
                    skills: ['Recruitment', 'Training & Development', 'HR Analytics', 'Labour Law'],
                    score: 68,
                    uploadDate: new Date('2024-12-04')
                },
                {
                    id: 'demo-5',
                    filename: 'vo_van_e_backend.pdf',
                    full_name: 'Võ Văn E',
                    email: 'vovane@email.com',
                    phone: '0789123456',
                    position: 'Backend Developer',
                    experience: '6 năm',
                    education: [
                        { degree: 'Thạc sĩ Khoa học Máy tính', school: 'Đại học Quốc gia TP.HCM', year_range: '2015-2019' }
                    ],
                    work_experience: [
                        { position: 'Senior Backend Developer', company: 'Grab Vietnam', year_range: '2022-2024' },
                        { position: 'Backend Developer', company: 'ZaloPay', year_range: '2019-2022' }
                    ],
                    skills: ['Java', 'Spring Boot', 'MySQL', 'Redis', 'Microservices', 'Docker'],
                    score: 94,
                    uploadDate: new Date('2024-12-05')
                }
            ];

            // Add demo CVs to database
            cvDatabase = demoCVs;
            filteredCVs = [...cvDatabase];
            
            // Update displays
            updateStatistics();
            displayCVs(filteredCVs);
            updateRanking();
        }

        function initializeApp() {
            setupEventListeners();
            updateStatistics();
            createCharts();
            initializeWeightSliders();
        }

        function initializeWeightSliders() {
            // Initialize all weight sliders with default values
            const defaultWeights = {
                'job-relevance': 25,
                'professionalism': 15,
                'experience': 20,
                'achievements': 15,
                'skills': 15,
                'soft-skills': 5,
                'education': 5
            };

            Object.keys(defaultWeights).forEach(key => {
                const weight = defaultWeights[key];
                const slider = document.getElementById(key + '-weight');
                const valueDisplay = document.getElementById(key + '-value');
                const percentDisplay = document.getElementById(key + '-percent');
                
                if (slider && valueDisplay && percentDisplay) {
                    slider.value = weight;
                    valueDisplay.textContent = weight;
                    percentDisplay.textContent = weight + '%';
                }
            });

            updateTotalWeight();
        }

        function updateStatistics() {
            const total = cvDatabase.length;
            const excellent = cvDatabase.filter(cv => cv.score >= 80).length;
            const good = cvDatabase.filter(cv => cv.score >= 60 && cv.score < 80).length;
            const average = cvDatabase.filter(cv => cv.score >= 40 && cv.score < 60).length;
            
            // Update management tab stats
            const totalCvsElement = document.getElementById('total-cvs');
            if (totalCvsElement) {
                totalCvsElement.textContent = `${total} CV`;
            }
            
            // Update analytics tab stats
            const statElements = {
                'stat-total': total,
                'stat-excellent': excellent,
                'stat-good': good,
                'stat-average': average
            };
            
            Object.keys(statElements).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = statElements[id];
                }
            });
        }

        function displayCVs(cvs) {
            const cvGrid = document.getElementById('cv-grid');
            if (!cvGrid) return;

            if (cvs.length === 0) {
                cvGrid.innerHTML = `
                    <p style="text-align: center; color: #64748b; font-style: italic; padding: 2rem; grid-column: 1 / -1;">
                        📂 Không tìm thấy CV nào phù hợp với bộ lọc.
                    </p>
                `;
                return;
            }

            cvGrid.innerHTML = cvs.map(cv => `
                <div class="cv-card ${getScoreClass(cv.score)}">
                    <div class="cv-header">
                        <div class="cv-name">${cv.full_name}</div>
                        <div class="cv-score ${getScoreClass(cv.score, 'score')}">${cv.score}</div>
                    </div>
                    <div class="cv-details">
                        <div class="cv-detail">
                            <span class="material-symbols-outlined">work</span>
                            <span>${cv.position}</span>
                        </div>
                        <div class="cv-detail">
                            <span class="material-symbols-outlined">schedule</span>
                            <span>${cv.experience}</span>
                        </div>
                        <div class="cv-detail">
                            <span class="material-symbols-outlined">email</span>
                            <span>${cv.email}</span>
                        </div>
                        <div class="cv-detail">
                            <span class="material-symbols-outlined">phone</span>
                            <span>${cv.phone}</span>
                        </div>
                    </div>
                    <div class="cv-actions">
                        <button class="btn btn-small btn-primary" onclick="viewCVDetails('${cv.id}')">
                            <span class="material-symbols-outlined">visibility</span>
                            Xem
                        </button>
                        <button class="btn btn-small btn-secondary" onclick="downloadCV('${cv.id}')">
                            <span class="material-symbols-outlined">download</span>
                            Tải
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getScoreClass(score, type = 'card') {
            const prefix = type === 'score' ? 'score-' : '';
            if (score >= 80) return prefix + 'excellent';
            if (score >= 60) return prefix + 'good';
            if (score >= 40) return prefix + 'average';
            return prefix + 'poor';
        }

        function updateRanking() {
            const rankingTbody = document.getElementById('ranking-tbody');
            if (!rankingTbody) return;

            const sortedCVs = [...cvDatabase].sort((a, b) => b.score - a.score);
            
            rankingTbody.innerHTML = sortedCVs.map((cv, index) => `
                <tr>
                    <td class="rank-cell">
                        <div class="rank-badge rank-${index < 3 ? index + 1 : 'other'}">${index + 1}</div>
                    </td>
                    <td>
                        <div class="candidate-info">
                            <div class="candidate-avatar">${cv.full_name.charAt(0)}</div>
                            <div class="candidate-details">
                                <h4>${cv.full_name}</h4>
                                <p>${cv.email}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="position-badge">${cv.position}</span>
                    </td>
                    <td class="experience-cell">${cv.experience}</td>
                    <td class="score-cell">
                        <span class="score-badge ${getScoreClass(cv.score, 'score')}">${cv.score}</span>
                    </td>
                    <td class="actions-cell">
                        <div class="action-buttons">
                            <button class="action-btn primary" onclick="viewCVDetails('${cv.id}')">
                                <span class="material-symbols-outlined">visibility</span>
                                Xem
                            </button>
                            <button class="action-btn secondary" onclick="downloadCV('${cv.id}')">
                                <span class="material-symbols-outlined">download</span>
                                Tải
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function viewCVDetails(cvId) {
            const cv = cvDatabase.find(c => c.id === cvId);
            if (!cv) return;
            
            alert(`📋 Chi tiết CV: ${cv.full_name}\n\n` +
                  `📧 Email: ${cv.email}\n` +
                  `📞 Phone: ${cv.phone}\n` +
                  `💼 Vị trí: ${cv.position}\n` +
                  `⏰ Kinh nghiệm: ${cv.experience}\n` +
                  `⭐ Điểm: ${cv.score}/100\n` +
                  `🎓 Học vấn: ${cv.education.map(e => e.degree).join(', ')}\n` +
                  `🔧 Kỹ năng: ${cv.skills.join(', ')}`);
        }

        function downloadCV(cvId) {
            const cv = cvDatabase.find(c => c.id === cvId);
            if (!cv) return;
            
            alert(`📥 Tải CV: ${cv.filename}\n\n(Demo: Tính năng tải CV sẽ được triển khai trong phiên bản thật)`);
        }

        function createCharts() {
            // Chart creation will be implemented later
            console.log('Charts initialized');
        }

        function applyFilters() {
            const keyword = document.getElementById('search-keyword')?.value.toLowerCase() || '';
            const scoreFilter = document.getElementById('score-filter')?.value || '';
            
            filteredCVs = cvDatabase.filter(cv => {
                const matchesKeyword = !keyword || 
                    cv.full_name.toLowerCase().includes(keyword) ||
                    cv.position.toLowerCase().includes(keyword) ||
                    cv.email.toLowerCase().includes(keyword) ||
                    cv.skills.some(skill => skill.toLowerCase().includes(keyword));
                
                const matchesScore = !scoreFilter || getScoreClass(cv.score).includes(scoreFilter);
                
                return matchesKeyword && matchesScore;
            });
            
            displayCVs(filteredCVs);
            updateStatistics();
        }

        function resetFilters() {
            document.getElementById('search-keyword').value = '';
            document.getElementById('score-filter').value = '';
            filteredCVs = [...cvDatabase];
            displayCVs(filteredCVs);
            updateStatistics();
        }

        // Chatbot Functions
        function sendMessage(message = null) {
            const textarea = document.getElementById('chatbotTextarea');
            const text = message || textarea.value.trim();
            
            if (!text) return;
            
            // Add user message
            addChatMessage(text, 'user');
            
            // Clear input
            if (!message) textarea.value = '';
            
            // Simulate AI response
            setTimeout(() => {
                const response = generateAIResponse(text);
                addChatMessage(response, 'bot');
            }, 1000);
        }

        function addChatMessage(text, sender) {
            const messagesContainer = document.getElementById('chatbotMessages');
            const time = new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            
            const messageHTML = `
                <div class="message ${sender}">
                    <div class="message-avatar">${sender === 'bot' ? '🤖' : '👤'}</div>
                    <div>
                        <div class="message-content">${text}</div>
                        <div class="message-time">${time}</div>
                    </div>
                </div>
            `;
            
            messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function generateAIResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            if (message.includes('phân tích') || message.includes('dữ liệu')) {
                const total = cvDatabase.length;
                const avgScore = Math.round(cvDatabase.reduce((sum, cv) => sum + cv.score, 0) / total);
                return `📊 **Phân tích dữ liệu CV hiện tại:**\n\n• Tổng CV: ${total}\n• Điểm trung bình: ${avgScore}/100\n• CV xuất sắc (≥80): ${cvDatabase.filter(cv => cv.score >= 80).length}\n• CV tốt (60-79): ${cvDatabase.filter(cv => cv.score >= 60 && cv.score < 80).length}\n\n💡 **Đề xuất:** Nên tập trung vào các CV có điểm ≥70 để có ứng viên chất lượng cao.`;
            }
            
            if (message.includes('top') || message.includes('xuất sắc')) {
                const topCVs = cvDatabase.sort((a, b) => b.score - a.score).slice(0, 3);
                const topList = topCVs.map((cv, i) => `${i+1}. **${cv.full_name}** - ${cv.position} (${cv.score} điểm)`).join('\n');
                return `🏆 **Top 3 ứng viên xuất sắc nhất:**\n\n${topList}\n\n💡 **Đề xuất:** Nên ưu tiên phỏng vấn những ứng viên này trước.`;
            }
            
            if (message.includes('vị trí') || message.includes('thống kê')) {
                const positions = {};
                cvDatabase.forEach(cv => {
                    positions[cv.position] = (positions[cv.position] || 0) + 1;
                });
                const positionList = Object.entries(positions).map(([pos, count]) => `• ${pos}: ${count} CV`).join('\n');
                return `📈 **Thống kê CV theo vị trí:**\n\n${positionList}\n\n💡 **Đề xuất:** Có thể mở thêm vòng tuyển dụng cho các vị trí có nhiều ứng viên chất lượng.`;
            }
            
            if (message.includes('tiêu chí') || message.includes('cải thiện')) {
                return `⚙️ **Đề xuất cải thiện tiêu chí đánh giá:**\n\n• Tăng trọng số "Kinh nghiệm" lên 25-30% cho vị trí senior\n• Tăng trọng số "Kỹ năng chuyên môn" cho vị trí technical\n• Tăng trọng số "Thành tựu" cho vị trí sales/marketing\n\n💡 Bạn có thể sử dụng mẫu tiêu chí theo ngành trong tab "Tùy Chỉnh Tiêu Chí".`;
            }
            
            return `🤖 Cảm ơn bạn đã hỏi! Tôi hiểu bạn muốn biết về "${userMessage}". \n\n📋 Tôi có thể hỗ trợ bạn với:\n• Phân tích dữ liệu CV\n• Top ứng viên xuất sắc\n• Thống kê theo vị trí\n• Cải thiện tiêu chí đánh giá\n\nHãy hỏi cụ thể hơn để tôi có thể hỗ trợ tốt nhất! 😊`;
        }

        // Chatbot toggle
        document.addEventListener('DOMContentLoaded', function() {
            const chatbotToggle = document.getElementById('chatbotToggle');
            const chatbotContainer = document.getElementById('chatbotContainer');
            const chatbotClose = document.getElementById('chatbotClose');
            
            chatbotToggle?.addEventListener('click', () => {
                chatbotContainer?.classList.add('open');
            });
            
            chatbotClose?.addEventListener('click', () => {
                chatbotContainer?.classList.remove('open');
            });
            
            // Handle suggestion chips
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('suggestion-chip')) {
                    const suggestion = e.target.textContent.trim();
                    sendMessage(suggestion);
                }
            });
            
            // Handle enter key in textarea
            document.getElementById('chatbotTextarea')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        });

        function setupEventListeners() {
            // Tab navigation
            navTabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // File upload
            uploadArea.addEventListener('click', () => cvFiles.click());
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('drop', handleDrop);
            cvFiles.addEventListener('change', handleFileUpload);

            // Filters
            document.getElementById('apply-filters').addEventListener('click', applyFilters);
            document.getElementById('reset-filters').addEventListener('click', resetFilters);

            // Search on input change
            document.getElementById('search-keyword').addEventListener('input', applyFilters);

            // Weight sliders
            const weightSliders = document.querySelectorAll('.weight-slider');
            weightSliders.forEach(slider => {
                slider.addEventListener('input', (e) => {
                    const value = e.target.value;
                    const id = e.target.id;
                    const valueDisplay = document.getElementById(id.replace('-weight', '-value'));
                    const percentDisplay = document.getElementById(id.replace('-weight', '-percent'));
                    
                    if (valueDisplay) valueDisplay.textContent = value;
                    if (percentDisplay) percentDisplay.textContent = value + '%';
                    
                    updateTotalWeight();
                });
            });
        }

        function switchTab(tabName) {
            // Update tab buttons
            navTabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Update tab content
            tabContents.forEach(content => {
                content.classList.toggle('active', content.id === `${tabName}-tab`);
            });

            // Update data when switching to certain tabs
            if (tabName === 'manage') {
                displayCVs(cvDatabase);
            } else if (tabName === 'analytics') {
                updateRanking();
                updateStatistics();
                updateCharts();
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.style.borderColor = '#667eea';
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.style.borderColor = '#e2e8f0';
            const files = Array.from(e.dataTransfer.files);
            processFiles(files);
        }

        function handleFileUpload(e) {
            const files = Array.from(e.target.files);
            processFiles(files);
        }

        async function processFiles(files) {
            if (files.length === 0) return;

            // Validate files
            const validFiles = files.filter(file => validateFile(file));
            if (validFiles.length === 0) {
                alert('Không có file hợp lệ để xử lý!');
                return;
            }

            // Show progress
            uploadProgress.style.display = 'block';
            uploadResults.style.display = 'none';
            loading.classList.add('show');

            const results = [];
            const totalFiles = validFiles.length;

            for (let i = 0; i < validFiles.length; i++) {
                const file = validFiles[i];
                const progress = ((i + 1) / totalFiles) * 100;
                
                progressBar.style.width = `${progress}%`;
                uploadStatus.textContent = `Đang xử lý file ${i + 1}/${totalFiles}: ${file.name}`;

                try {
                    const cvData = await analyzeCVFile(file);
                    cvDatabase.push(cvData);
                    results.push({ file: file.name, status: 'success', data: cvData });
                } catch (error) {
                    console.error('Error processing file:', file.name, error);
                    results.push({ file: file.name, status: 'error', error: error.message });
                }

                // Small delay to show progress
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            // Hide progress and show results
            uploadProgress.style.display = 'none';
            loading.classList.remove('show');
            displayUploadResults(results);
            updateStatistics();
            updateRanking();
            updateCharts();
        }

        function validateFile(file) {
            const allowedTypes = [
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'image/jpeg',
                'image/jpg',
                'image/png'
            ];
            
            const allowedExtensions = ['.pdf', '.doc', '.docx', '.jpg', '.jpeg', '.png'];
            const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            
            if (!allowedTypes.includes(file.type) && !allowedExtensions.includes(fileExtension)) {
                alert(`File ${file.name} không được hỗ trợ. Vui lòng chọn file PDF, DOC, DOCX, JPG hoặc PNG`);
                return false;
            }
            
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert(`File ${file.name} quá lớn. Vui lòng chọn file nhỏ hơn 10MB`);
                return false;
            }
            
            return true;
        }

        async function analyzeCVFile(file) {
            try {
                // 1. Read the actual CV content from file
                const cvText = await readCVContent(file);
                
                // 2. Parse CV using Gemini AI
                const parsedData = await parseCvUsingGemini(cvText);
                
                // 3. Calculate score using fixed formula instead of AI
                const analysis = calculateCVScore(cvText, parsedData);
                
                // 4. Build complete CV data object
                return {
                    id: Date.now() + Math.random(),
                    fileName: file.name,
                    name: parsedData.full_name || 'Không xác định',
                    email: parsedData.email || null,
                    phone: parsedData.phone || null,
                    education: parsedData.education,
                    work_experience: parsedData.work_experience,
                    position: detectPosition(cvText, parsedData.work_experience),
                    experience: calculateExperience(parsedData.work_experience),
                    score: analysis.score,
                    breakdown: analysis.breakdown, // Lưu chi tiết điểm số
                    reason: analysis.reason,      // Lưu lý do điểm số
                    skills: extractSkills(cvText),
                    uploadDate: new Date(),
                    status: analysis.score >= 90 ? 'excellent' : analysis.score >= 80 ? 'good' : analysis.score >= 70 ? 'average' : 'poor',
                    rawText: cvText
                };
            } catch (error) {
                console.error('Error analyzing CV:', error);
                throw error;
            }
        }

        // Function to read CV content from different file types
        async function readCVContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                if (file.type.startsWith('image/')) {
                    // For image files, try to extract text using OCR (Vision API or fallback)
                    reader.onload = async (e) => {
                        try {
                            // Try to use Google Vision API for OCR
                            const base64Data = e.target.result.split(',')[1];
                            const ocrText = await extractTextFromImage(base64Data);
                            
                            if (ocrText && ocrText.trim().length > 50) {
                                resolve(ocrText);
                            } else {
                                // Fallback: Ask user to manually enter or use different file
                                const userText = prompt(`File ảnh "${file.name}" cần được chuyển đổi thành văn bản.\n\nVui lòng nhập nội dung CV từ ảnh này (hoặc hủy để sử dụng file khác):`);
                                
                                if (userText && userText.trim().length > 0) {
                                    resolve(userText.trim());
                                } else {
                                    resolve(`CV từ file ảnh: ${file.name}\n[Cần nhập thủ công hoặc sử dụng file PDF/Word để đọc tự động]`);
                                }
                            }
                        } catch (error) {
                            console.error('OCR Error:', error);
                            // Fallback for image files
                            const userText = prompt(`Không thể đọc tự động file ảnh "${file.name}".\n\nVui lòng nhập nội dung CV từ ảnh này:`);
                            
                            if (userText && userText.trim().length > 0) {
                                resolve(userText.trim());  
                            } else {
                                resolve(`CV từ file ảnh: ${file.name}\n[Cần nhập thủ công để phân tích chính xác]`);
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                    
                } else if (file.type === 'application/pdf') {
                    // For PDF files, try to extract text
                    reader.onload = async (e) => {
                        try {
                            // Try to use PDF.js or similar library for text extraction
                            const pdfText = await extractTextFromPDF(e.target.result);
                            
                            if (pdfText && pdfText.trim().length > 50) {
                                resolve(pdfText);
                            } else {
                                // Fallback: Ask user to provide content
                                const userText = prompt(`File PDF "${file.name}" không thể đọc tự động.\n\nVui lòng nhập nội dung CV từ PDF này (hoặc hủy để sử dụng file khác):`);
                                
                                if (userText && userText.trim().length > 0) {
                                    resolve(userText.trim());
                                } else {
                                    resolve(`CV từ file PDF: ${file.name}\n[Cần nhập thủ công để phân tích chính xác]`);
                                }
                            }
                        } catch (error) {
                            console.error('PDF Reading Error:', error);
                            // Fallback for PDF files
                            const userText = prompt(`Không thể đọc tự động file PDF "${file.name}".\n\nVui lòng nhập nội dung CV từ PDF này:`);
                            
                            if (userText && userText.trim().length > 0) {
                                resolve(userText.trim());
                            } else {
                                resolve(`CV từ file PDF: ${file.name}\n[Cần nhập thủ công để phân tích chính xác]`);
                            }
                        }
                    };
                    reader.readAsArrayBuffer(file);
                    
                } else {
                    // For DOC/DOCX and plain text files
                    reader.onload = (e) => {
                        const result = e.target.result;
                        
                        if (typeof result === 'string' && result.trim().length > 0) {
                            // Successfully read as text
                            resolve(result);
                        } else {
                            // For binary DOC files, ask user to provide content
                            const userText = prompt(`File "${file.name}" cần được chuyển đổi thành văn bản.\n\nVui lòng nhập nội dung CV từ file này (hoặc hủy để sử dụng file khác):`);
                            
                            if (userText && userText.trim().length > 0) {
                                resolve(userText.trim());
                            } else {
                                resolve(`CV từ file: ${file.name}\n[Cần nhập thủ công để phân tích chính xác]`);
                            }
                        }
                    };
                                        reader.readAsText(file, 'UTF-8');
                }
                
                reader.onerror = reject;
            });
        }

        // Helper function to extract text from images using OCR
        async function extractTextFromImage(base64Data) {
            try {
                // Option 1: Use Google Vision API (if available)
                const response = await fetch(`https://vision.googleapis.com/v1/images:annotate?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requests: [{
                            image: { content: base64Data },
                            features: [{ type: 'TEXT_DETECTION', maxResults: 1 }]
                        }]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.responses && data.responses[0].textAnnotations) {
                        return data.responses[0].textAnnotations[0].description;
                    }
                }
            } catch (error) {
                console.error('Vision API Error:', error);
            }
            
            // Option 2: Use Gemini API for image analysis
            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: "Extract all text content from this CV image. Return only the plain text content without any formatting or explanations." },
                                { inline_data: { mime_type: "image/jpeg", data: base64Data } }
                            ]
                        }],
                        generationConfig: { temperature: 0, maxOutputTokens: 2048 }
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                }
            } catch (error) {
                console.error('Gemini OCR Error:', error);
            }
            
            return null;
        }
        
        // Helper function to extract text from PDF files  
        async function extractTextFromPDF(arrayBuffer) {
            try {
                // Option 1: Use PDF.js library if available
                if (typeof pdfjsLib !== 'undefined') {
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    let fullText = '';
                    
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n';
                    }
                    
                    return fullText.trim();
                }
            } catch (error) {
                console.error('PDF.js Error:', error);
            }
            
            // Option 2: Convert to base64 and use Gemini API
            try {
                const base64Data = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: "Extract all text content from this PDF document. Return only the plain text content without any formatting or explanations." },
                                { inline_data: { mime_type: "application/pdf", data: base64Data } }
                            ]
                        }],
                        generationConfig: { temperature: 0, maxOutputTokens: 2048 }
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text;
                }
            } catch (error) {
                console.error('Gemini PDF Error:', error);
            }
            
            return null;
        }

        // Function to calculate CV score using custom weights or default formula
        function calculateCVScore(cvText, parsedData) {
            let score = 0;
            
            // Get custom scoring weights from localStorage or use defaults
            const weights = getScoringWeights();
            
            let breakdown = {
                jobRelevance: 0,       // Default: 50 điểm max
                professionalism: 0,    // Default: 30 điểm max
                experience: 0,         // Default: 40 điểm max  
                achievements: 0,       // Default: 30 điểm max
                skills: 0,             // Default: 30 điểm max
                softSkills: 0,         // Default: 20 điểm max
                education: 0           // Default: 30 điểm max
            };

            // 1. ĐIỂM CHUYÊN NGHIỆP VÀ RÕ RÀNG
            const professionalismMax = weights.professionalism;
            let professionalismScore = 0;
            
            // Có email (20% của trọng số)
            if (parsedData.email) professionalismScore += professionalismMax * 0.2;
            
            // Có số điện thoại (20% của trọng số)
            if (parsedData.phone) professionalismScore += professionalismMax * 0.2;
            
            // Có họ tên đầy đủ (20% của trọng số)
            if (parsedData.full_name && parsedData.full_name.length > 5) professionalismScore += professionalismMax * 0.2;
            
            // CV có cấu trúc tốt - check keywords (20% của trọng số)
            const structureKeywords = ['học vấn', 'kinh nghiệm', 'kỹ năng', 'thông tin', 'liên hệ', 'education', 'experience', 'skills'];
            const foundStructure = structureKeywords.filter(keyword => 
                cvText.toLowerCase().includes(keyword.toLowerCase())).length;
            if (foundStructure >= 3) professionalismScore += professionalismMax * 0.2;
            
            // CV đủ dài và chi tiết (20% của trọng số)
            if (cvText.length > 500) professionalismScore += professionalismMax * 0.2;
            
            breakdown.professionalism = Math.min(professionalismMax, professionalismScore);

            // 2. ĐIỂM KINH NGHIỆM
            const experienceMax = weights.experience;
            let experienceScore = 0;
            
            if (parsedData.work_experience && parsedData.work_experience.length > 0) {
                // Có ít nhất 1 kinh nghiệm (33% của trọng số)
                experienceScore += experienceMax * 0.33;
                
                // Mỗi kinh nghiệm thêm (50% của trọng số, chia theo số lượng)
                const additionalExpWeight = experienceMax * 0.5;
                experienceScore += Math.min(additionalExpWeight, (parsedData.work_experience.length - 1) * (additionalExpWeight / 3));
                
                // Kinh nghiệm có mô tả chi tiết (17% của trọng số)
                const hasDetailedExp = parsedData.work_experience.some(exp => 
                    exp.position && exp.company && exp.year_range);
                if (hasDetailedExp) experienceScore += experienceMax * 0.17;
            }
            
            breakdown.experience = Math.min(experienceMax, experienceScore);

            // 3. ĐIỂM KỸ NĂNG
            const skillsMax = weights.skills;
            let skillsScore = 0;
            
            const skillKeywords = [
                // Programming languages
                'javascript', 'python', 'java', 'c++', 'c#', 'php', 'ruby', 'go', 'swift', 'kotlin',
                // Frontend
                'react', 'vue', 'angular', 'html', 'css', 'bootstrap', 'tailwind',
                // Backend  
                'node.js', 'express', 'django', 'flask', 'spring', 'laravel',
                // Database
                'mysql', 'postgresql', 'mongodb', 'redis', 'sqlite',
                // Tools
                'git', 'docker', 'kubernetes', 'aws', 'azure', 'jenkins',
                // Design
                'photoshop', 'figma', 'sketch', 'adobe', 'ui/ux'
            ];
            
            const foundSkills = skillKeywords.filter(skill => 
                cvText.toLowerCase().includes(skill.toLowerCase())).length;
            
            // Kỹ năng chiếm 80% của trọng số, mỗi kỹ năng có giá trị bằng nhau (tối đa 10 kỹ năng)
            const skillsWeightPortion = skillsMax * 0.8;
            skillsScore += Math.min(skillsWeightPortion, foundSkills * (skillsWeightPortion / 10));
            
            // Có mục kỹ năng riêng biệt (20% của trọng số)
            if (cvText.toLowerCase().includes('kỹ năng') || cvText.toLowerCase().includes('skills')) {
                skillsScore += skillsMax * 0.2;
            }
            
            breakdown.skills = Math.min(skillsMax, skillsScore);

            // 4. ĐIỂM HỌC VẤN
            const educationMax = weights.education;
            let educationScore = 0;
            
            if (parsedData.education && parsedData.education.length > 0) {
                // Có ít nhất 1 bằng cấp (50% của trọng số)
                educationScore += educationMax * 0.5;
                
                // Bằng cấp có thông tin chi tiết (25% của trọng số)
                const hasDetailedEdu = parsedData.education.some(edu => 
                    edu.degree && edu.school && edu.year_range);
                if (hasDetailedEdu) educationScore += educationMax * 0.25;
                
                // Bằng đại học/cao học (25% của trọng số)
                const hasHigherEdu = parsedData.education.some(edu => 
                    edu.degree && (
                        edu.degree.toLowerCase().includes('đại học') ||
                        edu.degree.toLowerCase().includes('cử nhân') ||
                        edu.degree.toLowerCase().includes('kỹ sư') ||
                        edu.degree.toLowerCase().includes('thạc sĩ') ||
                        edu.degree.toLowerCase().includes('bachelor') ||
                        edu.degree.toLowerCase().includes('master')
                    ));
                if (hasHigherEdu) educationScore += educationMax * 0.25;
            }
            
            breakdown.education = Math.min(educationMax, educationScore);

            // 5. ĐIỂM MỨC ĐỘ PHÙ HỢP VỚI VỊ TRÍ (Job Relevance)
            const jobRelevanceMax = weights.jobRelevance;
            let jobRelevanceScore = 0;
            
            // Logic đánh giá phù hợp với vị trí (mô phỏng, trong ứng dụng thực tế sẽ cần JD để so sánh)
            // Giả định có một số từ khóa của JD để so sánh
            const jobPositionKeywords = ['developer', 'lập trình viên', 'kỹ sư phần mềm', 'product manager', 'ui/ux', 
                                       'marketing', 'sales', 'nhân sự', 'tài chính', 'kế toán'];
            
            // Tìm từ khóa vị trí trong CV (30% của trọng số)
            const foundPositionKeywords = jobPositionKeywords.filter(keyword => 
                cvText.toLowerCase().includes(keyword.toLowerCase())).length;
            jobRelevanceScore += Math.min(jobRelevanceMax * 0.3, foundPositionKeywords * (jobRelevanceMax * 0.15));
            
            // Kiểm tra xem kinh nghiệm làm việc có phù hợp với vị trí (40% của trọng số)
            if (parsedData.work_experience && parsedData.work_experience.length > 0) {
                // Kiểm tra số năm kinh nghiệm (giả định yêu cầu 2+ năm)
                let hasRelevantExp = parsedData.work_experience.some(exp => {
                    if (exp.year_range) {
                        // Phân tích thời gian làm việc (giả định định dạng "2018-2022" hoặc "2018-present")
                        const years = exp.year_range.split('-');
                        if (years.length === 2) {
                            const start = parseInt(years[0]);
                            const end = years[1].toLowerCase() === 'present' ? new Date().getFullYear() : parseInt(years[1]);
                            if (!isNaN(start) && !isNaN(end) && (end - start) >= 2) {
                                return true;
                            }
                        }
                    }
                    return false;
                });
                
                if (hasRelevantExp) jobRelevanceScore += jobRelevanceMax * 0.4;
            }
            
            // Các kỹ năng cốt lõi cho vị trí (30% của trọng số)
            // Giả định một số kỹ năng cốt lõi (thực tế sẽ dựa vào JD)
            const coreSkillsKeywords = ['javascript', 'react', 'node.js', 'sql', 'java', 'python', 'marketing', 'sales', 'communication'];
            const foundCoreSkills = coreSkillsKeywords.filter(skill => 
                cvText.toLowerCase().includes(skill.toLowerCase())).length;
            jobRelevanceScore += Math.min(jobRelevanceMax * 0.3, foundCoreSkills * (jobRelevanceMax * 0.1));
            
            breakdown.jobRelevance = Math.min(jobRelevanceMax, jobRelevanceScore);

            // 6. ĐIỂM THÀNH TỰU VÀ KẾT QUẢ (Achievements)
            const achievementsMax = weights.achievements;
            let achievementsScore = 0;
            
            // Tìm các chỉ số định lượng (%, con số, tăng trưởng, giảm chi phí, v.v.) (50% của trọng số)
            const quantifiableRegex = /\d+(\.\d+)?%|\btăng\b.*\d+|\bgiảm\b.*\d+|\bhoàn thành\b|\bthành công\b|\bgold\b|\baward\b|\bgiải thưởng\b/gi;
            const quantifiableMatches = cvText.match(quantifiableRegex) || [];
            achievementsScore += Math.min(achievementsMax * 0.5, quantifiableMatches.length * (achievementsMax * 0.1));
            
            // Các dự án đặc biệt/giải thưởng (30% của trọng số)
            const projectRegex = /\bdự án\b|\bproject\b|\bgiải thưởng\b|\baward\b|\bcertificat/gi;
            const projectMatches = cvText.match(projectRegex) || [];
            achievementsScore += Math.min(achievementsMax * 0.3, projectMatches.length * (achievementsMax * 0.1));
            
            // Vai trò lãnh đạo (20% của trọng số) 
            const leadershipRegex = /\blãnh đạo\b|\bquản lý\b|\bteam lead\b|\bmanager\b|\bhead\b|\blead\b|\btrưởng\b|\bmanage\b/gi;
            const leadershipMatches = cvText.match(leadershipRegex) || [];
            if (leadershipMatches.length > 0) achievementsScore += achievementsMax * 0.2;
            
            breakdown.achievements = Math.min(achievementsMax, achievementsScore);

            // 7. ĐIỂM KỸ NĂNG MỀM (Soft Skills)
            const softSkillsMax = weights.softSkills;
            let softSkillsScore = 0;
            
            // Danh sách các kỹ năng mềm phổ biến
            const softSkillKeywords = [
                'giao tiếp', 'communication', 'teamwork', 'làm việc nhóm', 'leadership', 'lãnh đạo',
                'giải quyết vấn đề', 'problem solving', 'critical thinking', 'tư duy phản biện',
                'adaptability', 'thích nghi', 'sáng tạo', 'creativity', 'time management', 'quản lý thời gian',
                'thuyết trình', 'presentation', 'đàm phán', 'negotiation', 'emotional intelligence', 'trí tuệ cảm xúc'
            ];
            
            // Tìm các kỹ năng mềm trong CV (70% của trọng số)
            const foundSoftSkills = softSkillKeywords.filter(skill => 
                cvText.toLowerCase().includes(skill.toLowerCase())).length;
            softSkillsScore += Math.min(softSkillsMax * 0.7, foundSoftSkills * (softSkillsMax * 0.1));
            
            // Hoạt động ngoại khóa, tình nguyện, câu lạc bộ (30% của trọng số)
            const extracurricularRegex = /\btình nguyện\b|\bvolunteer\b|\bcâu lạc bộ\b|\bclub\b|\bhoạt động\b|\bactivit(y|ies)\b|\bextracurricular\b/gi;
            const extracurricularMatches = cvText.match(extracurricularRegex) || [];
            softSkillsScore += Math.min(softSkillsMax * 0.3, extracurricularMatches.length * (softSkillsMax * 0.1));
            
            breakdown.softSkills = Math.min(softSkillsMax, softSkillsScore);

            // TỔNG ĐIỂM
            score = breakdown.jobRelevance + breakdown.professionalism + breakdown.experience + 
                    breakdown.achievements + breakdown.skills + breakdown.softSkills + breakdown.education;
            
            console.log('CV Score Breakdown:', breakdown, 'Total:', score);
            
            return { 
                score: Math.round(Math.min(100, Math.max(0, score)) * 100) / 100,
                breakdown: {
                    jobRelevance: Math.round(breakdown.jobRelevance * 100) / 100,
                    professionalism: Math.round(breakdown.professionalism * 100) / 100,
                    experience: Math.round(breakdown.experience * 100) / 100,
                    achievements: Math.round(breakdown.achievements * 100) / 100,
                    skills: Math.round(breakdown.skills * 100) / 100,
                    softSkills: Math.round(breakdown.softSkills * 100) / 100,
                    education: Math.round(breakdown.education * 100) / 100
                },
                reason: `Phù hợp vị trí: ${(breakdown.jobRelevance).toFixed(2)}/${weights.jobRelevance}, Chuyên nghiệp: ${(breakdown.professionalism).toFixed(2)}/${weights.professionalism}, Kinh nghiệm: ${(breakdown.experience).toFixed(2)}/${weights.experience}, Thành tựu: ${(breakdown.achievements).toFixed(2)}/${weights.achievements}, Kỹ năng chuyên môn: ${(breakdown.skills).toFixed(2)}/${weights.skills}, Kỹ năng mềm: ${(breakdown.softSkills).toFixed(2)}/${weights.softSkills}, Học vấn: ${(breakdown.education).toFixed(2)}/${weights.education}`
            };
        }

        // Helper function to detect position from CV content
        function detectPosition(cvText, workExperience) {
            const text = cvText.toLowerCase();
            
            // Check work experience first
            if (workExperience && workExperience.length > 0) {
                const latestJob = workExperience[0].position.toLowerCase();
                if (latestJob.includes('frontend') || latestJob.includes('front-end')) return 'frontend';
                if (latestJob.includes('backend') || latestJob.includes('back-end')) return 'backend';
                if (latestJob.includes('fullstack') || latestJob.includes('full-stack')) return 'fullstack';
                if (latestJob.includes('mobile') || latestJob.includes('android') || latestJob.includes('ios')) return 'mobile';
                if (latestJob.includes('data') || latestJob.includes('analyst')) return 'data';
                if (latestJob.includes('design') || latestJob.includes('ui') || latestJob.includes('ux')) return 'design';
                if (latestJob.includes('marketing')) return 'marketing';
            }
            
            // Check CV text content
            if (text.includes('frontend') || text.includes('react') || text.includes('vue')) return 'frontend';
            if (text.includes('backend') || text.includes('server') || text.includes('api')) return 'backend';
            if (text.includes('fullstack') || text.includes('full stack')) return 'fullstack';
            if (text.includes('mobile') || text.includes('android') || text.includes('ios')) return 'mobile';
            if (text.includes('data science') || text.includes('machine learning')) return 'data';
            if (text.includes('designer') || text.includes('photoshop')) return 'design';
            if (text.includes('marketing') || text.includes('seo')) return 'marketing';
            
            return 'other';
        }

        // Helper function to calculate experience level
        function calculateExperience(workExperience) {
            if (!workExperience || workExperience.length === 0) return '0-1';
            
            let totalYears = 0;
            workExperience.forEach(exp => {
                if (exp.year_range) {
                    const years = exp.year_range.match(/(\d{4})/g);
                    if (years && years.length >= 2) {
                        totalYears += parseInt(years[1]) - parseInt(years[0]);
                    }
                }
            });
            
            if (totalYears >= 5) return '5+';
            if (totalYears >= 3) return '3-5';
            if (totalYears >= 1) return '1-3';
            return '0-1';
        }

        // Helper function to extract skills from CV text
        function extractSkills(cvText) {
            const skillKeywords = [
                'JavaScript', 'Python', 'Java', 'C++', 'C#', 'PHP', 'Ruby', 'Go', 'Rust',
                'React', 'Vue.js', 'Angular', 'Node.js', 'Express', 'Laravel', 'Django',
                'HTML', 'CSS', 'SCSS', 'Bootstrap', 'Tailwind',
                'MySQL', 'PostgreSQL', 'MongoDB', 'Redis', 'SQLite',
                'Git', 'Docker', 'AWS', 'Azure', 'Kubernetes', 'CI/CD',
                'Photoshop', 'Figma', 'Adobe XD', 'Sketch'
            ];
            
            const foundSkills = [];
            const text = cvText.toLowerCase();
            
            skillKeywords.forEach(skill => {
                if (text.includes(skill.toLowerCase())) {
                    foundSkills.push(skill);
                }
            });
            
            return foundSkills.slice(0, 8); // Limit to 8 skills
        }

        function displayUploadResults(results) {
            uploadResults.style.display = 'block';
            
            const successCount = results.filter(r => r.status === 'success').length;
            const errorCount = results.filter(r => r.status === 'error').length;

            resultsList.innerHTML = `
                <div style="background: #f0f9ff; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                    <h4>Kết quả xử lý:</h4>
                    <p>✅ Thành công: ${successCount} file</p>
                    <p>❌ Lỗi: ${errorCount} file</p>
                </div>
                
                ${results.map(result => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: ${result.status === 'success' ? '#f0f9ff' : '#fef2f2'}; border-radius: 8px; margin-bottom: 0.5rem;">
                        <span>${result.file}</span>
                        <span style="color: ${result.status === 'success' ? '#10b981' : '#ef4444'};">
                            ${result.status === 'success' ? '✅ Thành công' : '❌ Lỗi'}
                        </span>
                    </div>
                `).join('')}
                       `;
        }

        function displayCVs(cvs) {
            filteredCVs = cvs;
            cvGrid.innerHTML = '';

            if (cvs.length === 0) {
                cvGrid.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">Không có CV nào phù hợp với bộ lọc</div>';
                return;
            }

            cvs.forEach(cv => {
                const cvCard = document.createElement('div');
                cvCard.className = `cv-card ${cv.status}`;
                cvCard.innerHTML = `
                    <div class="cv-header">
                        <div class="cv-name">${cv.name}</div>
                        <div class="cv-score score-${cv.status}">${parseFloat(cv.score).toFixed(2)}</div>
                    </div>
                    <div class="cv-details">
                        <div class="cv-detail">
                            <span class="material-symbols-outlined">work</span>
                            <span>${getPositionName(cv.position)}</span>
                        </div>
                        <div class="cv-detail">
                            <span class="material-symbols-outlined">schedule</span>
                            <span>${cv.experience} năm kinh nghiệm</span>
                        </div>
                        <div class="cv-detail">
                            <span class="material-symbols-outlined">school</span>
                            <span>${cv.education}</span>
                        </div>
                        <div class="cv-detail">
                            <span class="material-symbols-outlined">skills</span>
                            <span>${cv.skills.slice(0, 3).join(', ')}</span>
                        </div>
                    </div>
                    <div class="cv-actions">
                        <button class="btn btn-primary btn-small" onclick="viewCVDetails('${cv.id}')">
                            <span class="material-symbols-outlined">visibility</span>
                            Xem chi tiết
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="downloadCV('${cv.id}')">
                            <span class="material-symbols-outlined">download</span>
                            Tải xuống
                        </button>
                    </div>
                `;
                cvGrid.appendChild(cvCard);
            });

            // Update database stats in management tab
            const totalCvsElement = document.getElementById('total-cvs');
            const excellentCvsElement = document.getElementById('excellent-cvs');
            const goodCvsElement = document.getElementById('good-cvs');

            if (totalCvsElement) totalCvsElement.textContent = filteredCVs.length;
            if (excellentCvsElement) excellentCvsElement.textContent = filteredCVs.filter(cv => cv.score >= 90).length;
            if (goodCvsElement) goodCvsElement.textContent = filteredCVs.filter(cv => cv.score >= 80 && cv.score < 90).length;
        }

        function applyFilters() {
            const position = document.getElementById('filter-position').value;
            const experience = document.getElementById('filter-experience').value;
            const scoreRange = document.getElementById('filter-score').value;
            const keyword = document.getElementById('search-keyword').value.toLowerCase();

            let filtered = cvDatabase.filter(cv => {
                // Position filter
                if (position && cv.position !== position) return false;
                
                // Experience filter
                if (experience && cv.experience !== experience) return false;
                
                // Score filter
                if (scoreRange) {
                    const [min, max] = scoreRange.split('-').map(Number);
                    if (max) {
                        if (cv.score < min || cv.score > max) return false;
                    } else {
                        if (cv.score < min) return false;
                    }
                }
                
                // Keyword search
                if (keyword) {
                    const searchText = `${cv.name} ${cv.skills.join(' ')} ${cv.education} ${cv.position}`.toLowerCase();
                    if (!searchText.includes(keyword)) return false;
                }
                
                return true;
            });

            displayCVs(filtered);
        }

        function resetFilters() {
            document.getElementById('filter-position').value = '';
            document.getElementById('filter-experience').value = '';
            document.getElementById('filter-score').value = '';
            document.getElementById('search-keyword').value = '';
            displayCVs(cvDatabase);
        }

        function updateRanking() {
            const sortedCVs = [...cvDatabase].sort((a, b) => b.score - a.score);
            const rankingTbody = document.getElementById('ranking-tbody');
            
            if (!rankingTbody) return;
            
            rankingTbody.innerHTML = '';
            
            sortedCVs.slice(0, 20).forEach((cv, index) => {
                const rank = index + 1;
                const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-other';
                
                // Get score class
                let scoreClass = 'score-poor';
                if (cv.score >= 90) scoreClass = 'score-excellent';
                else if (cv.score >= 80) scoreClass = 'score-good';
                else if (cv.score >= 70) scoreClass = 'score-average';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="rank-cell">
                        <div class="rank-badge ${rankClass}">${rank}</div>
                    </td>
                    <td>
                        <div class="candidate-info">
                            <div class="candidate-avatar">${cv.name.charAt(0).toUpperCase()}</div>
                            <div class="candidate-details">
                                <h4>${cv.name}</h4>
                                <p>${cv.email || 'Không có email'}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="position-badge">${getPositionName(cv.position)}</span>
                    </td>
                    <td class="experience-cell">
                        ${cv.experience || 'N/A'}
                    </td>
                    <td class="score-cell">
                        <div class="score-badge ${scoreClass}">
                            ${parseFloat(cv.score).toFixed(1)}
                        </div>
                    </td>
                    <td class="actions-cell">
                        <div class="action-buttons">
                            <button class="action-btn primary" onclick="viewCVDetails('${cv.id}')" title="Xem chi tiết">
                                <span class="material-symbols-outlined">visibility</span>
                            </button>
                            <button class="action-btn secondary" onclick="downloadCV('${cv.id}')" title="Tải xuống">
                                <span class="material-symbols-outlined">download</span>
                            </button>
                        </div>
                    </td>
                `;
                rankingTbody.appendChild(row);
            });
            
            // Add empty state if no data
            if (sortedCVs.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="6" style="text-align: center; padding: 2rem; color: #666;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
                            <span class="material-symbols-outlined" style="font-size: 3rem; color: #cbd5e1;">folder_open</span>
                            <p>Chưa có CV nào trong hệ thống</p>
                            <p style="font-size: 0.9rem; color: #9ca3af;">Tải lên CV để xem bảng xếp hạng</p>
                        </div>
                    </td>
                `;
                rankingTbody.appendChild(emptyRow);
            }
        }

        function updateStatistics() {
            const total = cvDatabase.length;
            const excellent = cvDatabase.filter(cv => cv.score >= 90).length;
            const good = cvDatabase.filter(cv => cv.score >= 80 && cv.score < 90).length;
            const average = total > 0 ? Math.round(cvDatabase.reduce((sum, cv) => sum + cv.score, 0) / total) : 0;

            // Update the correct element IDs based on the HTML structure
            const totalElement = document.getElementById('stat-total');
            const excellentElement = document.getElementById('stat-excellent');
            const goodElement = document.getElementById('stat-good');
            const averageElement = document.getElementById('stat-average');

            if (totalElement) totalElement.textContent = total;
            if (excellentElement) excellentElement.textContent = excellent;
            if (goodElement) goodElement.textContent = good;
            if (averageElement) averageElement.textContent = average;
        }

        function createCharts() {
            // Score distribution chart
            const scoreCanvas = document.getElementById('scoreChart');
            if (scoreCanvas) {
                const scoreCtx = scoreCanvas.getContext('2d');
                charts.scoreChart = new Chart(scoreCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Xuất sắc (180-200)', 'Tốt (160-179)', 'Khá (140-159)', 'Cần cải thiện (<140)'],
                        datasets: [{
                            data: [0, 0, 0, 0],
                            backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // Position distribution chart
            const positionCanvas = document.getElementById('positionChart');
            if (positionCanvas) {
                const positionCtx = positionCanvas.getContext('2d');
                charts.positionChart = new Chart(positionCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                '#667eea', '#764ba2', '#10b981', '#3b82f6',
                                '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        function updateCharts() {
            if (!charts.scoreChart || !charts.positionChart) return;

            // Update score chart
            const scoreData = [
                cvDatabase.filter(cv => cv.score >= 90).length,
                cvDatabase.filter(cv => cv.score >= 80 && cv.score < 90).length,
                cvDatabase.filter(cv => cv.score >= 70 && cv.score < 80).length,
                cvDatabase.filter(cv => cv.score < 70).length
            ];
            charts.scoreChart.data.datasets[0].data = scoreData;
            charts.scoreChart.update();

            // Update position chart
            const positions = {};
            cvDatabase.forEach(cv => {
                const positionName = getPositionName(cv.position);
                positions[positionName] = (positions[positionName] || 0) + 1;
            });
            charts.positionChart.data.labels = Object.keys(positions);
            charts.positionChart.data.datasets[0].data = Object.values(positions);
            charts.positionChart.update();
        }

        // Utility functions
        function getPositionName(position) {
            const positions = {
                frontend: 'Frontend Developer',
                backend: 'Backend Developer',
                fullstack: 'Fullstack Developer',
                mobile: 'Mobile Developer',
                data: 'Data Scientist',
                design: 'UI/UX Designer',
                marketing: 'Marketing',
                other: 'Khác'
            };
            return positions[position] || position;
        }

        function getStatusText(status) {
            const statusTexts = {
                excellent: 'Xuất sắc',
                good: 'Tốt',
                average: 'Khá',
                poor: 'Cần cải thiện'
            };
            return statusTexts[status] || status;
        }

        function getScoreColor(score) {
            if (score >= 90) return '#10b981';
            if (score >= 80) return '#3b82f6';
            if (score >= 70) return '#f59e0b';
            return '#ef4444';
        }

        function viewCVDetails(cvId) {
            const cv = cvDatabase.find(c => c.id == cvId);
            if (!cv) return;

            // Show detailed score breakdown instead of simple alert
            showScoreBreakdown(cvId);
        }

        function downloadCV(cvId) {
            const cv = cvDatabase.find(c => c.id == cvId);
            if (!cv) return;

            // Simulate download
            alert(`Đang tải xuống CV của ${cv.name}...`);
        }

        // Function to show detailed CV score breakdown
        function showScoreBreakdown(cvId) {
            const cv = cvDatabase.find(c => c.id == cvId);
            if (!cv || !cv.breakdown) return;

            const breakdown = cv.breakdown;
            // Get current weights for scoring display
            const weights = getScoringWeights();
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0; color: #1a202c;">Chi Tiết Điểm CV</h3>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <strong>Ứng viên:</strong> ${cv.name}<br>
                        <strong>Tổng điểm:</strong> <span style="color: ${getScoreColor(cv.score)}; font-weight: bold; font-size: 1.2rem;">${cv.score}/200</span>
                    </div>
                    
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                        <h4 style="margin-top: 0;">📋 Công Thức Tính Điểm</h4>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>🎯 Mức độ Phù hợp với Vị trí:</span>
                                <span style="font-weight: bold; color: ${breakdown.jobRelevance >= weights.jobRelevance*0.8 ? '#10b981' : breakdown.jobRelevance >= weights.jobRelevance*0.6 ? '#f59e0b' : '#ef4444'};">
                                    ${breakdown.jobRelevance}/${weights.jobRelevance}
                                </span>
                            </div>
                            <div style="background: #e2e8f0; height: 8px; border-radius: 4px;">
                                <div style="background: ${breakdown.jobRelevance >= weights.jobRelevance*0.8 ? '#10b981' : breakdown.jobRelevance >= weights.jobRelevance*0.6 ? '#f59e0b' : '#ef4444'}; height: 100%; width: ${(breakdown.jobRelevance/weights.jobRelevance)*100}%; border-radius: 4px;"></div>
                            </div>
                            <small style="color: #666;">Mức độ phù hợp với yêu cầu công việc</small>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>📝 Chuyên nghiệp & Rõ ràng:</span>
                                <span style="font-weight: bold; color: ${breakdown.professionalism >= weights.professionalism*0.8 ? '#10b981' : breakdown.professionalism >= weights.professionalism*0.6 ? '#f59e0b' : '#ef4444'};">
                                    ${breakdown.professionalism}/${weights.professionalism}
                                </span>
                            </div>
                            <div style="background: #e2e8f0; height: 8px; border-radius: 4px;">
                                <div style="background: ${breakdown.professionalism >= weights.professionalism*0.8 ? '#10b981' : breakdown.professionalism >= weights.professionalism*0.6 ? '#f59e0b' : '#ef4444'}; height: 100%; width: ${(breakdown.professionalism/weights.professionalism)*100}%; border-radius: 4px;"></div>
                            </div>
                            <small style="color: #666;">Email, SĐT, họ tên, cấu trúc CV, độ dài nội dung</small>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>💼 Kinh nghiệm làm việc:</span>
                                <span style="font-weight: bold; color: ${breakdown.experience >= weights.experience*0.8 ? '#10b981' : breakdown.experience >= weights.experience*0.6 ? '#f59e0b' : '#ef4444'};">
                                    ${breakdown.experience}/${weights.experience}
                                </span>
                            </div>
                            <div style="background: #e2e8f0; height: 8px; border-radius: 4px;">
                                <div style="background: ${breakdown.experience >= weights.experience*0.8 ? '#10b981' : breakdown.experience >= weights.experience*0.6 ? '#f59e0b' : '#ef4444'}; height: 100%; width: ${(breakdown.experience/weights.experience)*100}%; border-radius: 4px;"></div>
                            </div>
                            <small style="color: #666;">Số lượng và chất lượng kinh nghiệm làm việc</small>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>🏆 Thành tựu & Kết quả:</span>
                                <span style="font-weight: bold; color: ${breakdown.achievements >= weights.achievements*0.8 ? '#10b981' : breakdown.achievements >= weights.achievements*0.6 ? '#f59e0b' : '#ef4444'};">
                                    ${breakdown.achievements}/${weights.achievements}
                                </span>
                            </div>
                            <div style="background: #e2e8f0; height: 8px; border-radius: 4px;">
                                <div style="background: ${breakdown.achievements >= weights.achievements*0.8 ? '#10b981' : breakdown.achievements >= weights.achievements*0.6 ? '#f59e0b' : '#ef4444'}; height: 100%; width: ${(breakdown.achievements/weights.achievements)*100}%; border-radius: 4px;"></div>
                            </div>
                            <small style="color: #666;">Thành tựu cụ thể với con số và kết quả</small>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>🛠️ Kỹ năng chuyên môn:</span>
                                <span style="font-weight: bold; color: ${breakdown.skills >= weights.skills*0.8 ? '#10b981' : breakdown.skills >= weights.skills*0.6 ? '#f59e0b' : '#ef4444'};">
                                    ${breakdown.skills}/${weights.skills}
                                </span>
                            </div>
                            <div style="background: #e2e8f0; height: 8px; border-radius: 4px;">
                                <div style="background: ${breakdown.skills >= weights.skills*0.8 ? '#10b981' : breakdown.skills >= weights.skills*0.6 ? '#f59e0b' : '#ef4444'}; height: 100%; width: ${(breakdown.skills/weights.skills)*100}%; border-radius: 4px;"></div>
                            </div>
                            <small style="color: #666;">Ngôn ngữ lập trình, framework, tools, design</small>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>🤝 Kỹ năng mềm:</span>
                                <span style="font-weight: bold; color: ${breakdown.softSkills >= weights.softSkills*0.8 ? '#10b981' : breakdown.softSkills >= weights.softSkills*0.6 ? '#f59e0b' : '#ef4444'};">
                                    ${breakdown.softSkills}/${weights.softSkills}
                                </span>
                            </div>
                            <div style="background: #e2e8f0; height: 8px; border-radius: 4px;">
                                <div style="background: ${breakdown.softSkills >= weights.softSkills*0.8 ? '#10b981' : breakdown.softSkills >= weights.softSkills*0.6 ? '#f59e0b' : '#ef4444'}; height: 100%; width: ${(breakdown.softSkills/weights.softSkills)*100}%; border-radius: 4px;"></div>
                            </div>
                            <small style="color: #666;">Kỹ năng giao tiếp, làm việc nhóm, lãnh đạo</small>
                        </div>
                        
                        <div style="margin-bottom: 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>🎓 Học vấn:</span>
                                <span style="font-weight: bold; color: ${breakdown.education >= weights.education*0.8 ? '#10b981' : breakdown.education >= weights.education*0.6 ? '#f59e0b' : '#ef4444'};">
                                    ${breakdown.education}/${weights.education}
                                </span>
                            </div>
                            <div style="background: #e2e8f0; height: 8px; border-radius: 4px;">
                                <div style="background: ${breakdown.education >= weights.education*0.8 ? '#10b981' : breakdown.education >= weights.education*0.6 ? '#f59e0b' : '#ef4444'}; height: 100%; width: ${(breakdown.education/weights.education)*100}%; border-radius: 4px;"></div>
                            </div>
                            <small style="color: #666;">Bằng cấp, trường học, mức độ học vấn</small>
                        </div>
                    </div>
                    
                    <div style="background: #e6fffa; padding: 1rem; border-radius: 10px; border-left: 4px solid #10b981;">
                        <h4 style="margin-top: 0; color: #065f46;">💡 Gợi ý cải thiện:</h4>
                        <ul style="margin: 0; padding-left: 1rem;">
                            ${breakdown.jobRelevance < weights.jobRelevance*0.7 ? '<li>Điều chỉnh CV để phù hợp hơn với vị trí đang ứng tuyển</li>' : ''}
                            ${breakdown.professionalism < weights.professionalism*0.7 ? '<li>Bổ sung thông tin liên hệ đầy đủ và cấu trúc CV rõ ràng hơn</li>' : ''}
                            ${breakdown.experience < weights.experience*0.7 ? '<li>Mô tả chi tiết hơn về kinh nghiệm làm việc và dự án</li>' : ''}
                            ${breakdown.achievements < weights.achievements*0.7 ? '<li>Thêm thành tựu cụ thể và có thể định lượng được</li>' : ''}
                            ${breakdown.skills < weights.skills*0.7 ? '<li>Liệt kê đầy đủ kỹ năng chuyên môn và công nghệ sử dụng</li>' : ''}
                            ${breakdown.softSkills < weights.softSkills*0.7 ? '<li>Bổ sung thông tin về kỹ năng mềm và hoạt động ngoại khóa</li>' : ''}
                            ${breakdown.education < weights.education*0.7 ? '<li>Bổ sung thông tin học vấn, chứng chỉ, khóa học</li>' : ''}
                            ${cv.score >= 80 ? '<li>CV rất tốt! Tiếp tục duy trì chất lượng này.</li>' : ''}
                        </ul>
                    </div>
                    
                    <div style="text-align: right; margin-top: 1.5rem;">
                        <button onclick="this.closest('.modal').remove()" style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer;">
                            Đóng
                        </button>
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Show improvement notification
        function showCVReadingImprovement() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                z-index: 1000;
                max-width: 350px;
                font-size: 0.9rem;
                line-height: 1.4;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                    <span class="material-symbols-outlined" style="margin-right: 0.5rem;">upgrade</span>
                    <strong>Tiêu chí đánh giá tùy chỉnh!</strong>
                </div>
                <div>
                    ✅ Điểm CV giờ đây có thể tùy chỉnh theo nhu cầu<br>
                    ✅ Trọng số linh hoạt cho từng tiêu chí<br>
                    ✅ Chi tiết breakdown theo từng mục<br>
                    ✅ Tab "Tùy Chỉnh Tiêu Chí" để điều chỉnh
                </div>
                <div style="margin-top: 0.8rem; text-align: right;">
                    <button onclick="switchTab('settings')" 
                            style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 0.3rem 0.8rem; border-radius: 5px; cursor: pointer; margin-right: 0.5rem;">
                        Tùy Chỉnh Ngay
                    </button>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.3rem 0.8rem; border-radius: 5px; cursor: pointer;">
                        Đóng
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 12 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 12000);
        }

        // Show notification when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize charts
            createCharts();
            
            // Show improvement notification
            setTimeout(showCVReadingImprovement, 1000);
        });

        // AI Recruitment Advisor Chatbot
        class RecruitmentAdvisor {
            constructor() {
                this.isOpen = false;
                this.isTyping = false;
                this.messagesContainer = document.getElementById('chatbotMessages');
                this.inputTextarea = document.getElementById('chatbotInput');
                this.sendButton = document.getElementById('sendButton');
                this.chatbotContainer = document.getElementById('chatbotContainer');
                this.chatbotToggle = document.getElementById('chatbotToggle');
                this.chatbotClose = document.getElementById('chatbotClose');
                this.notificationBadge = document.getElementById('notificationBadge');
                
                this.expertKnowledge = this.initializeExpertKnowledge();
                this.conversationHistory = [];
                
                this.initializeEventListeners();
                this.showWelcomeNotification();
            }

            initializeExpertKnowledge() {
                return {
                    cvAnalysis: {
                        criteria: ['technical_skills', 'experience', 'education', 'projects', 'soft_skills'],
                        scoringMatrix: {
                            junior: { experience: 0.3, skills: 0.4, education: 0.2, projects: 0.1 },
                            mid: { experience: 0.4, skills: 0.3, education: 0.1, projects: 0.2 },
                            senior: { experience: 0.5, skills: 0.25, education: 0.05, projects: 0.2 }
                        }
                    },
                    interviewQuestions: {
                        technical: {
                            developer: [
                                "Giải thích khái niệm OOP và các nguyên tắc cơ bản",
                                "Sự khác biệt giữa SQL và NoSQL database",
                                "Cách optimize performance của ứng dụng web",
                                "Design patterns nào bạn thường sử dụng và tại sao?",
                                "Cách handle error và exception trong code"
                            ],
                            designer: [
                                "Quy trình thiết kế UX/UI của bạn như thế nào?",
                                "Cách bạn đảm bảo accessibility trong thiết kế",
                                "Kinh nghiệm với responsive design và mobile-first",
                                "Tools và software bạn thường sử dụng",
                                "Cách bạn thu thập và áp dụng user feedback"
                            ]
                        },
                        behavioral: [
                            "Kể về một lần bạn phải làm việc dưới áp lực deadline",
                            "Cách bạn handle conflict trong team",
                            "Dự án nào bạn tự hào nhất và tại sao?",
                            "Mục tiêu nghề nghiệp 5 năm tới của bạn",
                            "Cách bạn học hỏi và cập nhật kiến thức mới"
                        ]
                    },
                    salaryBenchmarks: {
                        hanoi: {
                            developer: { junior: '8-15', mid: '15-25', senior: '25-40' },
                            designer: { junior: '7-12', mid: '12-20', senior: '20-35' },
                            pm: { junior: '10-18', mid: '18-30', senior: '30-50' }
                        },
                        hcm: {
                            developer: { junior: '10-18', mid: '18-30', senior: '30-50' },
                            designer: { junior: '8-15', mid: '15-25', senior: '25-40' },
                            pm: { junior: '12-22', mid: '22-35', senior: '35-60' }
                        }
                    },
                    recruitmentTips: [
                        "Đánh giá cultural fit là quan trọng như technical skills",
                        "Sử dụng structured interview để đảm bảo công bằng",
                        "Provide clear job description và expectations",
                        "Give constructive feedback cho candidates",
                        "Build strong employer brand để attract top talents"
                    ]
                };
            }

            initializeEventListeners() {
                this.chatbotToggle.addEventListener('click', () => this.toggleChat());
                this.chatbotClose.addEventListener('click', () => this.closeChat());
                this.sendButton.addEventListener('click', () => this.sendMessage());
                
                this.inputTextarea.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.inputTextarea.addEventListener('input', () => {
                    this.autoResizeTextarea();
                    this.sendButton.disabled = !this.inputTextarea.value.trim();
                });

                // Suggestion chips
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('suggestion-chip')) {
                        const suggestion = e.target.getAttribute('data-suggestion');
                        this.inputTextarea.value = suggestion;
                        this.sendMessage();
                    }
                });
            }

            showWelcomeNotification() {
                setTimeout(() => {
                    this.notificationBadge.style.display = 'flex';
                    this.chatbotToggle.style.animation = 'bounceIn 0.5s ease';
                }, 3000);
            }

            toggleChat() {
                this.isOpen = !this.isOpen;
                this.chatbotContainer.classList.toggle('open', this.isOpen);
                this.notificationBadge.style.display = 'none';
                
                if (this.isOpen) {
                    this.inputTextarea.focus();
                }
            }

            closeChat() {
                this.isOpen = false;
                this.chatbotContainer.classList.remove('open');
            }

            autoResizeTextarea() {
                this.inputTextarea.style.height = 'auto';
                this.inputTextarea.style.height = Math.min(this.inputTextarea.scrollHeight, 80) + 'px';
            }

            async sendMessage() {
                const message = this.inputTextarea.value.trim();
                if (!message || this.isTyping) return;

                this.addMessage(message, 'user');
                this.inputTextarea.value = '';
                this.autoResizeTextarea();
                this.sendButton.disabled = true;

                this.showTypingIndicator();
                
                try {
                    const response = await this.generateResponse(message);
                    this.hideTypingIndicator();
                    this.addMessage(response.text, 'bot', response.suggestions);
                } catch (error) {
                    this.hideTypingIndicator();
                    this.addMessage('Xin lỗi, tôi gặp sự cố kỹ thuật. Vui lòng thử lại sau.', 'bot');
                }
            }

            addMessage(content, sender, suggestions = []) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const avatar = sender === 'bot' ? '🤖' : '👤';
                const time = new Date().toLocaleTimeString('vi-VN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                let suggestionsHTML = '';
                if (suggestions.length > 0) {
                    suggestionsHTML = `
                        <div class="suggestion-chips">
                            ${suggestions.map(s => `
                                <div class="suggestion-chip" data-suggestion="${s}">${s}</div>
                            `).join('')}
                        </div>
                    `;
                }

                messageDiv.innerHTML = `
                    <div class="message-avatar">${avatar}</div>
                    <div>
                        <div class="message-content">${content}</div>
                        ${suggestionsHTML}
                        <div class="message-time">${time}</div>
                    </div>
                `;

                this.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            showTypingIndicator() {
                this.isTyping = true;
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-indicator';
                typingDiv.id = 'typingIndicator';
                
                typingDiv.innerHTML = `
                    <div class="message-avatar">🤖</div>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;

                this.messagesContainer.appendChild(typingDiv);
                this.scrollToBottom();
            }

            hideTypingIndicator() {
                this.isTyping = false;
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            async generateResponse(userMessage) {
                // Simulate AI processing delay
                await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));
                
                const message = userMessage.toLowerCase();
                this.conversationHistory.push({ user: userMessage, timestamp: Date.now() });

                // Analyze current CV database
                if (this.containsKeywords(message, ['phân tích', 'dữ liệu', 'cv hiện tại', 'thống kê', 'báo cáo'])) {
                    return this.handleDataAnalysisQuery(message);
                }

                // Top candidates
                if (this.containsKeywords(message, ['top', 'ứng viên', 'xuất sắc', 'tốt nhất', 'ranking'])) {
                    return this.handleTopCandidatesQuery(message);
                }

                // Position statistics
                if (this.containsKeywords(message, ['thống kê', 'vị trí', 'position', 'phân bố'])) {
                    return this.handlePositionStatsQuery(message);
                }

                // CV Analysis
                if (this.containsKeywords(message, ['cv', 'hồ sơ', 'đánh giá', 'chấm điểm'])) {
                    return this.handleCVAnalysisQuery(message);
                }

                // Interview Questions
                if (this.containsKeywords(message, ['phỏng vấn', 'câu hỏi', 'interview'])) {
                    return this.handleInterviewQuery(message);
                }

                // Salary Inquiry
                if (this.containsKeywords(message, ['lương', 'salary', 'mức lương', 'thị trường'])) {
                    return this.handleSalaryQuery(message);
                }

                // Recruitment Strategy
                if (this.containsKeywords(message, ['chiến lược', 'tuyển dụng', 'strategy', 'recruit'])) {
                    return this.handleStrategyQuery(message);
                }

                // General/Default Response
                return this.handleGeneralQuery(message);
            }

            containsKeywords(text, keywords) {
                return keywords.some(keyword => text.includes(keyword));
            }

            handleDataAnalysisQuery(message) {
                const total = cvDatabase.length;
                const excellent = cvDatabase.filter(cv => cv.score >= 90).length;
                const good = cvDatabase.filter(cv => cv.score >= 80 && cv.score < 90).length;
                const average = cvDatabase.filter(cv => cv.score >= 70 && cv.score < 80).length;
                const poor = cvDatabase.filter(cv => cv.score < 70).length;
                const avgScore = total > 0 ? Math.round(cvDatabase.reduce((sum, cv) => sum + cv.score, 0) / total) : 0;

                // Position distribution
                const positions = {};
                cvDatabase.forEach(cv => {
                    const pos = getPositionName(cv.position);
                    positions[pos] = (positions[pos] || 0) + 1;
                });

                const topPosition = Object.keys(positions).reduce((a, b) => positions[a] > positions[b] ? a : b, '');

                return {
                    text: `📊 **Phân tích dữ liệu CV hiện tại:**

**📈 Tổng quan:**
• Tổng số CV: ${total} hồ sơ
• Điểm trung bình: ${avgScore}/200
• Vị trí phổ biến nhất: ${topPosition}

**⭐ Phân loại chất lượng:**
• Xuất sắc (180-200): ${excellent} CV (${total > 0 ? Math.round(excellent/total*100) : 0}%)
• Tốt (160-179): ${good} CV (${total > 0 ? Math.round(good/total*100) : 0}%)
• Khá (140-159): ${average} CV (${total > 0 ? Math.round(average/total*100) : 0}%)
• Cần cải thiện (<140): ${poor} CV (${total > 0 ? Math.round(poor/total*100) : 0}%)

**💼 Phân bố vị trí:**
${Object.entries(positions).slice(0, 5).map(([pos, count]) => 
    `• ${pos}: ${count} CV`).join('\n')}

**💡 Khuyến nghị:**
${excellent > 0 ? '• Có ' + excellent + ' ứng viên xuất sắc đáng chú ý' : '• Cần tìm kiếm thêm ứng viên chất lượng cao'}
${poor > total * 0.3 ? '• Cân nhắc nâng cao tiêu chuẩn tuyển dụng' : '• Chất lượng CV tổng thể khá tốt'}`,
                    suggestions: [
                        "Top 5 ứng viên xuất sắc nhất",
                        "CV cần cải thiện",
                        "Phân tích theo kỹ năng"
                    ]
                };
            }

            handleTopCandidatesQuery(message) {
                const sortedCVs = [...cvDatabase].sort((a, b) => b.score - a.score);
                const topCandidates = sortedCVs.slice(0, 5);

                if (topCandidates.length === 0) {
                    return {
                        text: '📂 Hiện tại chưa có CV nào trong hệ thống. Vui lòng tải lên CV để phân tích.',
                        suggestions: ['Hướng dẫn tải CV', 'Tiêu chí đánh giá CV']
                    };
                }

                return {
                    text: `🏆 **Top ${topCandidates.length} ứng viên xuất sắc nhất:**

${topCandidates.map((cv, index) => {
    const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
    return `${medal} **${cv.name}**
   • Điểm: ${cv.score}/200
   • Vị trí: ${getPositionName(cv.position)}
   • Kinh nghiệm: ${cv.experience}
   • Kỹ năng nổi bật: ${cv.skills.slice(0, 3).join(', ')}`;
}).join('\n\n')}

**💡 Đánh giá chung:**
• Điểm cao nhất: ${topCandidates[0].score}/200
• Kỹ năng đa dạng: ${[...new Set(topCandidates.flatMap(cv => cv.skills))].length} kỹ năng khác nhau
• Phù hợp cho phỏng vấn trực tiếp

**🎯 Khuyến nghị:**
• Ưu tiên liên hệ top 3 ứng viên
• Chuẩn bị câu hỏi phỏng vấn chuyên sâu
• Xem xét offer package cạnh tranh`,
                    suggestions: [
                        "Chi tiết ứng viên top 1",
                        "Câu hỏi phỏng vấn cho top candidates",
                        "So sánh với thị trường"
                    ]
                };
            }

            handlePositionStatsQuery(message) {
                const positions = {};
                const skillsByPosition = {};
                const scoresByPosition = {};

                cvDatabase.forEach(cv => {
                    const pos = getPositionName(cv.position);
                    positions[pos] = (positions[pos] || 0) + 1;
                    
                    if (!skillsByPosition[pos]) skillsByPosition[pos] = [];
                    skillsByPosition[pos].push(...cv.skills);
                    
                    if (!scoresByPosition[pos]) scoresByPosition[pos] = [];
                    scoresByPosition[pos].push(cv.score);
                });

                const sortedPositions = Object.entries(positions)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5);

                return {
                    text: `📈 **Thống kê CV theo vị trí:**

**📊 Phân bố vị trí (Top 5):**
${sortedPositions.map(([pos, count], index) => {
    const percentage = Math.round(count / cvDatabase.length * 100);
    const avgScore = scoresByPosition[pos] ? 
        Math.round(scoresByPosition[pos].reduce((a,b) => a+b, 0) / scoresByPosition[pos].length) : 0;
    const topSkills = skillsByPosition[pos] ? 
        [...new Set(skillsByPosition[pos])].slice(0, 3).join(', ') : 'N/A';
    
    return `${index + 1}. **${pos}**
   • Số lượng: ${count} CV (${percentage}%)
   • Điểm TB: ${avgScore}/200
   • Kỹ năng phổ biến: ${topSkills}`;
}).join('\n\n')}

**🎯 Insight từ dữ liệu:**
• Vị trí có nhu cầu cao nhất: ${sortedPositions[0] ? sortedPositions[0][0] : 'N/A'}
• Chất lượng ứng viên tốt nhất: ${
    Object.entries(scoresByPosition)
        .map(([pos, scores]) => [pos, scores.reduce((a,b) => a+b, 0) / scores.length])
        .sort(([,a], [,b]) => b - a)[0]?.[0] || 'N/A'
}
• Cần tăng cường tuyển dụng: ${sortedPositions.length < 3 ? 'Các vị trí khác' : 'Balanced distribution'}

**💡 Khuyến nghị tuyển dụng:**
• Focus vào ${sortedPositions[0]?.[0]} do nhu cầu cao
• Develop job posting cho vị trí thiếu hụt
• Optimize recruitment strategy theo từng vị trí`,
                    suggestions: [
                        "Phân tích kỹ năng theo vị trí",
                        "Benchmark lương theo vị trí", 
                        "Chiến lược tuyển dụng"
                    ]
                };
            }

            handleCVAnalysisQuery(message) {
                // Get current weights to show in the response
                const weights = getScoringWeights();
                
                const responses = [
                    {
                        text: `📊 **Hướng dẫn phân tích CV chuyên nghiệp:**

**1. Đánh giá kỹ năng kỹ thuật (40%)**
• Kiểm tra độ phù hợp với job requirements
• Đánh giá mức độ expertise qua projects
• Xem xét certifications và training

**2. Kinh nghiệm làm việc (35%)**
• Thời gian làm việc tại mỗi công ty
• Progression trong career path
• Relevance của previous roles

**3. Soft skills & Cultural fit (25%)**
• Communication skills qua CV presentation
• Leadership experience
• Teamwork indicators

**💡 Công thức tính điểm Tech CV (Tùy chỉnh):**
• Chuyên nghiệp & Rõ ràng: ${weights.professionalism} điểm
• Kinh nghiệm làm việc: ${weights.experience} điểm
• Kỹ năng chuyên môn: ${weights.skills} điểm
• Học vấn: ${weights.education} điểm

**🎯 Mẹo:** Bạn có thể điều chỉnh trọng số đánh giá CV ở tab "Tùy Chỉnh Tiêu Chí" để phù hợp với nhu cầu tuyển dụng của bạn!`,
                        suggestions: [
                            "Template đánh giá CV",
                            "Red flags cần tránh trong CV",
                            "Cách chỉnh sửa tiêu chí đánh giá"
                        ]
                    }
                ];
                
                return responses[0];
            }

            handleInterviewQuery(message) {
                let position = 'developer';
                if (message.includes('designer') || message.includes('thiết kế')) position = 'designer';
                if (message.includes('pm') || message.includes('project manager')) position = 'pm';

                const techQuestions = this.expertKnowledge.interviewQuestions.technical[position] || 
                                   this.expertKnowledge.interviewQuestions.technical.developer;
                
                const behavioralQuestions = this.expertKnowledge.interviewQuestions.behavioral;

                return {
                    text: `❓ **Câu hỏi phỏng vấn cho ${position.toUpperCase()}:**

**Technical Questions:**
${techQuestions.slice(0, 3).map((q, i) => `${i + 1}. ${q}`).join('\n')}

**Behavioral Questions:**
${behavioralQuestions.slice(0, 3).map((q, i) => `${i + 1}. ${q}`).join('\n')}

**💡 Tips phỏng vấn:**
• Sử dụng STAR method để evaluate answers
• Prepare follow-up questions
• Create comfortable interview environment
• Đánh giá cả technical và cultural fit`,
                    suggestions: [
                        "Câu hỏi technical advanced",
                        "Cách đánh giá soft skills",
                        "Tips tạo không khí thoải mái"
                    ]
                };
            }

            handleSalaryQuery(message) {
                let city = 'hanoi';
                if (message.includes('hcm') || message.includes('sài gòn') || message.includes('tp.hcm')) {
                    city = 'hcm';
                }

                let position = 'developer';
                if (message.includes('designer')) position = 'designer';
                if (message.includes('pm') || message.includes('project manager')) position = 'pm';

                const cityName = city === 'hanoi' ? 'Hà Nội' : 'TP.HCM';
                const salaryData = this.expertKnowledge.salaryBenchmarks[city][position];

                return {
                    text: `💰 **Mức lương ${position.toUpperCase()} tại ${cityName}:**

**Junior Level:** ${salaryData.junior} triệu VND/tháng
**Mid Level:** ${salaryData.mid} triệu VND/tháng  
**Senior Level:** ${salaryData.senior} triệu VND/tháng

**Factors ảnh hưởng lương:**
• Company size & industry
• Specific tech stack expertise
• English proficiency
• Leadership experience
• Market demand

**💡 Negotiation Tips:**
• Research company's salary range
• Highlight unique value proposition
• Consider total compensation package
• Be flexible với benefits

**📊 So sánh với CV database:**
${cvDatabase.length > 0 ? 
`• Avg score của ${position}: ${Math.round(cvDatabase.filter(cv => cv.position === position).reduce((sum, cv) => sum + cv.score, 0) / Math.max(1, cvDatabase.filter(cv => cv.position === position).length))}/200
• Top candidate score: ${Math.max(...cvDatabase.filter(cv => cv.position === position).map(cv => cv.score), 0)}/200` : 
'• Chưa có dữ liệu CV để so sánh'}`,
                    suggestions: [
                        "So sánh lương theo thành phố",
                        "Benefits package chuẩn",
                        "Cách negotiate lương hiệu quả"
                    ]
                };
            }

            handleStrategyQuery(message) {
                const tips = this.expertKnowledge.recruitmentTips;
                const randomTips = tips.sort(() => 0.5 - Math.random()).slice(0, 3);

                return {
                    text: `🎯 **Chiến lược tuyển dụng hiệu quả:**

**1. Pre-recruitment Planning**
• Define clear job requirements & expectations
• Create compelling job descriptions
• Set realistic timeline & budget

**2. Sourcing Strategy**
• Diversify sourcing channels (job boards, social media, referrals)
• Build talent pipeline for future needs
• Leverage employee referral programs

**3. Selection Process**
• Structured interview process
• Multiple stakeholder involvement
• Skills assessment & cultural fit evaluation

**Best Practices từ database:**
${randomTips.map((tip, i) => `• ${tip}`).join('\n')}

**📈 Insight từ CV database hiện tại:**
${cvDatabase.length > 0 ? 
`• Quality rate: ${Math.round(cvDatabase.filter(cv => cv.score >= 80).length / cvDatabase.length * 100)}% CV đạt chuẩn
• Cần focus: ${cvDatabase.filter(cv => cv.score < 70).length > 0 ? 'Nâng cao tiêu chuẩn screening' : 'Duy trì chất lượng hiện tại'}` :
'• Cần xây dựng CV database để insights tốt hơn'}`,
                    suggestions: [
                        "Employer branding tips",
                        "Candidate experience optimization",
                        "Remote hiring strategies"
                    ]
                };
            }

            handleGeneralQuery(message) {
                const dbStats = cvDatabase.length > 0 ? {
                    total: cvDatabase.length,
                    excellent: cvDatabase.filter(cv => cv.score >= 90).length,
                    avgScore: Math.round(cvDatabase.reduce((sum, cv) => sum + cv.score, 0) / cvDatabase.length)
                } : null;

                return {
                    text: `🤖 **AI Tư Vấn Tuyển Dụng - Tech CV**

Tôi là trợ lý AI chuyên về tuyển dụng! Tôi có thể hỗ trợ bạn:

• **Phân tích dữ liệu CV** - Insights từ ${dbStats?.total || 0} CV trong hệ thống
• **Top candidates** - Ranking và đánh giá ứng viên
• **Câu hỏi phỏng vấn** - Technical & behavioral questions  
• **Benchmark lương** - Market rates 2024
• **Chiến lược tuyển dụng** - Best practices & tips

${dbStats ? `
📊 **Database hiện tại:**
• ${dbStats.total} CV • ${dbStats.excellent} xuất sắc • Điểm TB: ${dbStats.avgScore}/200` : '📂 **Database trống** - Hãy tải lên CV để bắt đầu phân tích!'}

Hãy cho tôi biết bạn cần hỗ trợ gì cụ thể! 😊`,
                    suggestions: [
                        "Phân tích dữ liệu CV hiện tại",
                        "Top 5 ứng viên xuất sắc",
                        "Thống kê theo vị trí",
                        "Mức lương thị trường 2024"
                    ]
                };
            }

            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }
        }

        // Initialize the AI Recruitment Advisor
        document.addEventListener('DOMContentLoaded', () => {
            new RecruitmentAdvisor();
            initializeScoringSettings();
        });

        // Custom CV Scoring Weight Functions
        function getScoringWeights() {
            // Get custom weights from localStorage or use defaults
            const storedWeights = localStorage.getItem('cvScoringWeights');
            const defaultWeights = {
                jobRelevance: 25,
                professionalism: 15,
                experience: 20,
                achievements: 15,
                skills: 15,
                softSkills: 5,
                education: 5
            };
            
            return storedWeights ? JSON.parse(storedWeights) : defaultWeights;
        }
        
        function saveScoringWeights(weights) {
            localStorage.setItem('cvScoringWeights', JSON.stringify(weights));
            showNotification('Đã lưu thiết lập tiêu chí đánh giá CV', 'success');
        }
        
        function updateTotalWeight() {
            const jobRelevanceWeight = parseInt(document.getElementById('job-relevance-weight').value);
            const professionalismWeight = parseInt(document.getElementById('professionalism-weight').value);
            const experienceWeight = parseInt(document.getElementById('experience-weight').value);
            const achievementsWeight = parseInt(document.getElementById('achievements-weight').value);
            const skillsWeight = parseInt(document.getElementById('skills-weight').value);
            const softSkillsWeight = parseInt(document.getElementById('soft-skills-weight').value);
            const educationWeight = parseInt(document.getElementById('education-weight').value);
            
            const total = jobRelevanceWeight + professionalismWeight + experienceWeight + achievementsWeight + skillsWeight + softSkillsWeight + educationWeight;
            document.getElementById('total-weight').textContent = total;
            
            const warningElement = document.getElementById('weight-warning');
            if (total !== 100) {
                warningElement.style.display = 'flex';
                document.getElementById('save-weights').disabled = true;
            } else {
                warningElement.style.display = 'none';
                document.getElementById('save-weights').disabled = false;
            }
            
            // Update the preview chart
            updateWeightChart();
        }
        
        function initializeScoringSettings() {
            // Load current weights
            const weights = getScoringWeights();
            
            // Set the sliders to the stored values
            document.getElementById('job-relevance-weight').value = weights.jobRelevance;
            document.getElementById('job-relevance-value').textContent = weights.jobRelevance;
            document.getElementById('job-relevance-percent').textContent = weights.jobRelevance + '%';
            
            document.getElementById('professionalism-weight').value = weights.professionalism;
            document.getElementById('professionalism-value').textContent = weights.professionalism;
            document.getElementById('professionalism-percent').textContent = weights.professionalism + '%';
            
            document.getElementById('experience-weight').value = weights.experience;
            document.getElementById('experience-value').textContent = weights.experience;
            document.getElementById('experience-percent').textContent = weights.experience + '%';
            
            document.getElementById('achievements-weight').value = weights.achievements;
            document.getElementById('achievements-value').textContent = weights.achievements;
            document.getElementById('achievements-percent').textContent = weights.achievements + '%';
            
            document.getElementById('skills-weight').value = weights.skills;
            document.getElementById('skills-value').textContent = weights.skills;
            document.getElementById('skills-percent').textContent = weights.skills + '%';
            
            document.getElementById('soft-skills-weight').value = weights.softSkills;
            document.getElementById('soft-skills-value').textContent = weights.softSkills;
            document.getElementById('soft-skills-percent').textContent = weights.softSkills + '%';
            
            document.getElementById('education-weight').value = weights.education;
            document.getElementById('education-value').textContent = weights.education;
            document.getElementById('education-percent').textContent = weights.education + '%';
            
            // Set up event listeners for sliders
            document.querySelectorAll('.weight-slider').forEach(slider => {
                slider.addEventListener('input', function() {
                    // Update the displayed value
                    const valueDisplay = document.getElementById(this.id.replace('weight', 'value'));
                    valueDisplay.textContent = this.value;
                    
                    // Update the percentage display
                    const percentDisplay = document.getElementById(this.id.replace('weight', 'percent'));
                    if (percentDisplay) {
                        percentDisplay.textContent = this.value + '%';
                    }
                    
                    // Update total and validation
                    updateTotalWeight();
                });
            });
            
            // Set up event listeners for buttons
            document.getElementById('save-weights').addEventListener('click', function() {
                const newWeights = {
                    jobRelevance: parseInt(document.getElementById('job-relevance-weight').value),
                    professionalism: parseInt(document.getElementById('professionalism-weight').value),
                    experience: parseInt(document.getElementById('experience-weight').value),
                    achievements: parseInt(document.getElementById('achievements-weight').value),
                    skills: parseInt(document.getElementById('skills-weight').value),
                    softSkills: parseInt(document.getElementById('soft-skills-weight').value),
                    education: parseInt(document.getElementById('education-weight').value)
                };
                
                saveScoringWeights(newWeights);
                
                // Recalculate all CV scores with the new weights
                recalculateAllCVScores();
            });
            
            document.getElementById('reset-default-weights').addEventListener('click', function() {
                const defaultWeights = {
                    jobRelevance: 25,
                    professionalism: 15,
                    experience: 20,
                    achievements: 15,
                    skills: 15,
                    softSkills: 5,
                    education: 5
                };
                
                // Reset sliders
                document.getElementById('job-relevance-weight').value = defaultWeights.jobRelevance;
                document.getElementById('job-relevance-value').textContent = defaultWeights.jobRelevance;
                document.getElementById('job-relevance-percent').textContent = defaultWeights.jobRelevance + '%';
                
                document.getElementById('professionalism-weight').value = defaultWeights.professionalism;
                document.getElementById('professionalism-value').textContent = defaultWeights.professionalism;
                document.getElementById('professionalism-percent').textContent = defaultWeights.professionalism + '%';
                
                document.getElementById('experience-weight').value = defaultWeights.experience;
                document.getElementById('experience-value').textContent = defaultWeights.experience;
                document.getElementById('experience-percent').textContent = defaultWeights.experience + '%';
                
                document.getElementById('achievements-weight').value = defaultWeights.achievements;
                document.getElementById('achievements-value').textContent = defaultWeights.achievements;
                document.getElementById('achievements-percent').textContent = defaultWeights.achievements + '%';
                
                document.getElementById('skills-weight').value = defaultWeights.skills;
                document.getElementById('skills-value').textContent = defaultWeights.skills;
                document.getElementById('skills-percent').textContent = defaultWeights.skills + '%';
                
                document.getElementById('soft-skills-weight').value = defaultWeights.softSkills;
                document.getElementById('soft-skills-value').textContent = defaultWeights.softSkills;
                document.getElementById('soft-skills-percent').textContent = defaultWeights.softSkills + '%';
                
                document.getElementById('education-weight').value = defaultWeights.education;
                document.getElementById('education-value').textContent = defaultWeights.education;
                document.getElementById('education-percent').textContent = defaultWeights.education + '%';
                
                updateTotalWeight();
                
                showNotification('Đã khôi phục thiết lập mặc định', 'info');
            });
            
            // Initialize the chart
            createWeightChart();
            updateTotalWeight();
        }
        
        function createWeightChart() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const weights = getScoringWeights();
            
            // Create gradient backgrounds for all seven criteria
            const gradient1 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient1.addColorStop(0, 'rgba(59, 130, 246, 0.9)'); // Blue - Job Relevance
            gradient1.addColorStop(1, 'rgba(59, 130, 246, 0.7)');
            
            const gradient2 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient2.addColorStop(0, 'rgba(96, 165, 250, 0.9)'); // Light Blue - Professionalism
            gradient2.addColorStop(1, 'rgba(96, 165, 250, 0.7)');
            
            const gradient3 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient3.addColorStop(0, 'rgba(52, 211, 153, 0.9)'); // Green - Experience
            gradient3.addColorStop(1, 'rgba(52, 211, 153, 0.7)');
            
            const gradient4 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient4.addColorStop(0, 'rgba(16, 185, 129, 0.9)'); // Emerald - Achievements
            gradient4.addColorStop(1, 'rgba(16, 185, 129, 0.7)');
            
            const gradient5 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient5.addColorStop(0, 'rgba(167, 139, 250, 0.9)'); // Purple - Skills
            gradient5.addColorStop(1, 'rgba(167, 139, 250, 0.7)');
            
            const gradient6 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient6.addColorStop(0, 'rgba(139, 92, 246, 0.9)'); // Violet - Soft Skills
            gradient6.addColorStop(1, 'rgba(139, 92, 246, 0.7)');
            
            const gradient7 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient7.addColorStop(0, 'rgba(251, 191, 36, 0.9)'); // Yellow - Education
            gradient7.addColorStop(1, 'rgba(251, 191, 36, 0.7)');
            
            window.weightChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [
                        'Mức độ Phù hợp với Vị trí',
                        'Chuyên Nghiệp & Rõ Ràng',
                        'Kinh Nghiệm Làm Việc',
                        'Thành tựu & Kết quả',
                        'Kỹ Năng Chuyên Môn',
                        'Kỹ năng mềm / Phẩm chất cá nhân',
                        'Học Vấn'
                    ],
                    datasets: [{
                        data: [
                            weights.jobRelevance,
                            weights.professionalism,
                            weights.experience,
                            weights.achievements,
                            weights.skills,
                            weights.softSkills,
                            weights.education
                        ],
                        backgroundColor: [
                            gradient1,
                            gradient2,
                            gradient3,
                            gradient4,
                            gradient5,
                            gradient6,
                            gradient7
                        ],
                        borderWidth: 3,
                        borderColor: '#ffffff',
                        hoverBorderWidth: 5,
                        hoverBorderColor: [
                            '#3b82f6', // Blue - Job Relevance
                            '#60a5fa', // Light Blue - Professionalism
                            '#34d399', // Green - Experience
                            '#10b981', // Emerald - Achievements
                            '#a78bfa', // Purple - Skills
                            '#8b5cf6', // Violet - Soft Skills
                            '#fbbf24'  // Yellow - Education
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    radius: '90%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle',
                                boxWidth: 10,
                                font: {
                                    family: 'Inter',
                                    size: 13,
                                    weight: '600'
                                },
                                color: '#4a5568'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1a202c',
                            bodyColor: '#4a5568',
                            titleFont: {
                                family: 'Inter',
                                size: 14,
                                weight: '600'
                            },
                            bodyFont: {
                                family: 'Inter',
                                size: 13
                            },
                            padding: 15,
                            cornerRadius: 10,
                            boxPadding: 10,
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.raw}% (${Math.round(context.raw)} điểm)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true,
                        duration: 1000,
                        easing: 'easeOutCubic'
                    }
                }
            });
        }
        
        function updateWeightChart() {
            if (!window.weightChart) return;
            
            const jobRelevanceWeight = parseInt(document.getElementById('job-relevance-weight').value);
            const professionalismWeight = parseInt(document.getElementById('professionalism-weight').value);
            const experienceWeight = parseInt(document.getElementById('experience-weight').value);
            const achievementsWeight = parseInt(document.getElementById('achievements-weight').value);
            const skillsWeight = parseInt(document.getElementById('skills-weight').value);
            const softSkillsWeight = parseInt(document.getElementById('soft-skills-weight').value);
            const educationWeight = parseInt(document.getElementById('education-weight').value);
            
            window.weightChart.data.datasets[0].data = [
                jobRelevanceWeight,
                professionalismWeight,
                experienceWeight,
                achievementsWeight,
                skillsWeight,
                softSkillsWeight,
                educationWeight
            ];
            
            window.weightChart.update();
        }
        
        function recalculateAllCVScores() {
            if (cvDatabase.length === 0) return;
            
            console.log("Recalculating all CV scores with updated weights...");
            
            // Recalculate score for each CV
            cvDatabase.forEach(cv => {
                if (cv.rawText && cv.parsedData) {
                    const newScoreResult = calculateCVScore(cv.rawText, cv.parsedData);
                    cv.score = newScoreResult.score;
                    cv.breakdown = newScoreResult.breakdown;
                    cv.reason = newScoreResult.reason;
                    
                    console.log(`Recalculated score for ${cv.name}: ${cv.score}/200`);
                    console.log("Breakdown:", cv.breakdown);
                    
                    // Update status based on new score
                    if (cv.score >= 90) cv.status = 'excellent';
                    else if (cv.score >= 80) cv.status = 'good';
                    else if (cv.score >= 70) cv.status = 'average';
                    else cv.status = 'poor';
                }
            });
            
            // Update display
            displayCVs(cvDatabase);
            updateRanking();
            updateStatistics();
            updateCharts();
            
            showNotification('Tất cả điểm CV đã được tính toán lại với trọng số mới', 'success');
            
            showNotification('Đã cập nhật điểm cho tất cả CV theo tiêu chí mới', 'success');
        }
        
        function showNotification(message, type = 'info') {
            const notificationContainer = document.createElement('div');
            notificationContainer.className = `notification ${type}`;
            notificationContainer.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 10px;
                color: white;
                font-weight: 500;
                box-shadow: 0 4px 10px rgba(0,0,0,0.15);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            // Set background color based on type
            if (type === 'success') {
                notificationContainer.style.background = '#10b981';
            } else if (type === 'error') {
                notificationContainer.style.background = '#ef4444';
            } else if (type === 'warning') {
                notificationContainer.style.background = '#f59e0b';
            } else { // info
                notificationContainer.style.background = '#3b82f6';
            }
            
            notificationContainer.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.8rem;">
                    <span class="material-symbols-outlined">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notificationContainer);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notificationContainer.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notificationContainer.parentElement) {
                        notificationContainer.remove();
                    }
                }, 300);
            }, 3000);
        }

        // Add animation keyframes
        document.head.insertAdjacentHTML('beforeend', `
            <style>
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            </style>
        `);

    </script>
</body>
</html>  