
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trợ Lý CV AI - Nâng Tầm Sự Nghiệp Của Bạn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Be Vietnam Pro', sans-serif;
        background-color: #f9fafb;
        color: #1f2937;
      }
      .hidden {
        display: none;
      }
      /* Custom scrollbar for editor/preview panes */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }
    </style>
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>

    <header class="bg-white shadow-sm">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-10 w-10 text-blue-600">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                        <path d="M10 12h2"></path><path d="M14 16h-4"></path><path d="M14 8h-4"></path>
                    </svg>
                    <div class="ml-4">
                        <h1 class="text-xl font-bold text-gray-900">Trợ Lý CV AI</h1>
                        <p class="text-sm text-gray-500">Nâng tầm sự nghiệp của bạn</p>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Upload View -->
    <main id="upload-view" class="max-w-4xl mx-auto p-4 md:p-8 flex flex-col items-center justify-center text-center" style="min-height: calc(100vh - 80px);">
      <h2 class="text-3xl font-bold text-gray-900">Nâng cấp CV của bạn với AI</h2>
      <p class="mt-2 text-lg text-gray-600">Tải lên hoặc kéo thả ảnh CV của bạn để nhận phân tích chuyên sâu.</p>
      
      <div class="w-full mt-8 space-y-6">
        <div class="space-y-4">
          <label for="target-job-input" class="block text-sm font-medium text-gray-800">Vị trí công việc mục tiêu</label>
          <input type="text" id="target-job-input" value="Lập trình viên React" class="mx-auto block w-full max-w-md px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 font-semibold" placeholder="VD: Kỹ sư phần mềm">
        </div>
        
        <div id="image-upload-container" class="w-full max-w-xl mx-auto">
            <div id="image-preview-wrapper" class="relative hidden">
                <img id="image-preview" src="" alt="CV Preview" class="rounded-lg shadow-lg w-full">
                <button id="remove-image-button" class="absolute top-2 right-2 bg-black bg-opacity-50 text-white rounded-full p-1.5 hover:bg-opacity-75 transition-all">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg>
                </button>
            </div>

            <div id="drop-zone" class="cursor-pointer w-full p-10 border-2 border-dashed rounded-xl flex flex-col items-center justify-center transition-colors border-gray-300 bg-white hover:border-blue-400">
                <input id="file-input" type="file" class="hidden" accept="image/png, image/jpeg, image/webp">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 text-gray-400 mb-4"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"></path><path d="M12 12v9"></path><path d="m16 16-4-4-4 4"></path></svg>
                <p class="text-gray-700 font-semibold">Kéo và thả ảnh CV tại đây</p>
                <p class="text-gray-500 text-sm">hoặc nhấn để chọn tệp</p>
                <p class="text-xs text-gray-400 mt-2">Hỗ trợ PNG, JPG, WEBP</p>
            </div>
        </div>
        
        <div id="error-message" class="text-red-500 text-sm mt-2 hidden"></div>

        <button id="analyze-button" disabled class="flex items-center justify-center w-full max-w-md mx-auto px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-blue-300 disabled:cursor-not-allowed transition-all duration-300">
            <span id="analyze-button-text">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 inline-block"><path d="M15 4V2"></path><path d="M15 10V8"></path><path d="M10.18 4.5 11 2"></path><path d="M10.18 9.5 11 7"></path><path d="M5.31 6.5 6.13 4"></path><path d="M5.31 11.5 6.13 9"></path><path d="m2 15 2.24 2.24"></path><path d="m7 20 2.24 2.24"></path><path d="M12.76 22 22 12.76"></path><path d="m11 11 2.24 2.24"></path><path d="m16 16 2.24 2.24"></path><path d="M22 2 12.76 11.24"></path></svg>
                Phân tích CV với AI
            </span>
            <span id="analyze-button-loading" class="hidden">
                 <svg class="animate-spin w-5 h-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                Đang phân tích...
            </span>
        </button>
      </div>
    </main>

    <!-- Main View -->
    <main id="main-view" class="hidden p-4 md:p-8 grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-screen-2xl mx-auto">
        <!-- CV Editor Column -->
        <div id="cv-editor" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 h-full overflow-y-auto max-h-[calc(100vh-6rem)] custom-scrollbar"></div>

        <!-- Result Column -->
        <div class="flex flex-col">
          <div class="flex items-center justify-between mb-4">
            <div class="flex space-x-1 rounded-lg bg-gray-200 p-1">
                <button id="preview-tab" class="px-4 py-2 text-sm font-semibold rounded-md transition-colors bg-white text-blue-600 shadow">Xem trước CV</button>
                <button id="analysis-tab" class="px-4 py-2 text-sm font-semibold rounded-md transition-colors text-gray-600 hover:bg-gray-300">Phân Tích AI</button>
            </div>
            <button id="reanalyze-button" class="flex items-center justify-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 disabled:bg-blue-300 disabled:cursor-not-allowed transition-all duration-300">
               <span id="reanalyze-button-text">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 inline-block"><path d="M15 4V2"></path><path d="M15 10V8"></path><path d="M10.18 4.5 11 2"></path><path d="M10.18 9.5 11 7"></path><path d="M5.31 6.5 6.13 4"></path><path d="M5.31 11.5 6.13 9"></path><path d="m2 15 2.24 2.24"></path><path d="m7 20 2.24 2.24"></path><path d="M12.76 22 22 12.76"></path><path d="m11 11 2.24 2.24"></path><path d="m16 16 2.24 2.24"></path><path d="M22 2 12.76 11.24"></path></svg>
                  Phân tích lại
               </span>
               <span id="reanalyze-button-loading" class="hidden">
                 <svg class="animate-spin w-5 h-5 mr-3 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                 Đang phân tích lại...
               </span>
            </button>
          </div>
          
          <div id="result-container" class="h-full">
            <!-- CV Preview will be rendered here -->
            <div id="cv-preview-container" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-200 h-full overflow-y-auto max-h-[calc(100vh-12rem)] custom-scrollbar"></div>
            <!-- Analysis Result will be rendered here -->
            <div id="analysis-result-container" class="hidden bg-white p-6 rounded-xl shadow-lg border border-gray-200 h-full overflow-y-auto max-h-[calc(100vh-12rem)] custom-scrollbar"></div>
          </div>
        </div>
    </main>

    <script type="module">
        import { GoogleGenAI, Type } from "https://esm.sh/@google/genai@^1.11.0";

        // --- STATE MANAGEMENT ---
        let state = {
            cvData: null,
            cvImage: { file: null, preview: null },
            targetJob: 'Lập trình viên React',
            analysisResult: null,
            isLoading: false,
            error: null,
            activeTab: 'preview', // 'preview' or 'analysis'
            isDragging: false,
        };

        // --- DOM ELEMENTS ---
        const DOMElements = {
            uploadView: document.getElementById('upload-view'),
            mainView: document.getElementById('main-view'),
            targetJobInput: document.getElementById('target-job-input'),
            imageUploadContainer: document.getElementById('image-upload-container'),
            imagePreviewWrapper: document.getElementById('image-preview-wrapper'),
            imagePreview: document.getElementById('image-preview'),
            removeImageButton: document.getElementById('remove-image-button'),
            dropZone: document.getElementById('drop-zone'),
            fileInput: document.getElementById('file-input'),
            errorMessage: document.getElementById('error-message'),
            analyzeButton: document.getElementById('analyze-button'),
            analyzeButtonText: document.getElementById('analyze-button-text'),
            analyzeButtonLoading: document.getElementById('analyze-button-loading'),
            reanalyzeButton: document.getElementById('reanalyze-button'),
            reanalyzeButtonText: document.getElementById('reanalyze-button-text'),
            reanalyzeButtonLoading: document.getElementById('reanalyze-button-loading'),
            cvEditor: document.getElementById('cv-editor'),
            resultContainer: document.getElementById('result-container'),
            cvPreviewContainer: document.getElementById('cv-preview-container'),
            analysisResultContainer: document.getElementById('analysis-result-container'),
            previewTab: document.getElementById('preview-tab'),
            analysisTab: document.getElementById('analysis-tab'),
        };

        // --- GEMINI API SERVICE ---
        const ai = new GoogleGenAI({ apiKey: "AIzaSyC3QSqG1ZOpqy-EI8HQRdq0Z_W5MbweSws" });

        const cvDataSchema = {
            type: Type.OBJECT,
            properties: {
                fullName: { type: Type.STRING, description: "Họ và tên đầy đủ của ứng viên." },
                email: { type: Type.STRING, description: "Địa chỉ email." },
                phone: { type: Type.STRING, description: "Số điện thoại." },
                linkedin: { type: Type.STRING, description: "URL đến trang LinkedIn, nếu có." },
                summary: { type: Type.STRING, description: "Phần tóm tắt bản thân hoặc mục tiêu nghề nghiệp." },
                experience: {
                    type: Type.ARRAY,
                    description: "Danh sách kinh nghiệm làm việc.",
                    items: {
                        type: Type.OBJECT,
                        properties: {
                            company: { type: Type.STRING, description: "Tên công ty." },
                            title: { type: Type.STRING, description: "Chức danh." },
                            description: { type: Type.STRING, description: "Mô tả chi tiết công việc và thành tích." },
                        },
                         required: ["company", "title", "description"]
                    },
                },
                education: { type: Type.STRING, description: "Thông tin học vấn, bằng cấp." },
                skills: { type: Type.STRING, description: "Danh sách các kỹ năng, cách nhau bởi dấu phẩy." },
            },
            required: ["fullName", "summary", "experience", "education", "skills", "email", "phone", "linkedin"]
        };

        const analysisSchema = {
            type: Type.OBJECT,
            properties: {
                generalAnalysis: {
                    type: Type.OBJECT,
                    properties: {
                        strengths: { type: Type.ARRAY, items: { type: Type.STRING } },
                        weaknesses: { type: Type.ARRAY, items: { type: Type.STRING } },
                    },
                },
                detailedCorrections: {
                    type: Type.ARRAY,
                    items: {
                        type: Type.OBJECT,
                        properties: {
                            original: { type: Type.STRING },
                            suggestion: { type: Type.STRING },
                        },
                    },
                },
                enhancementSuggestions: {
                    type: Type.OBJECT,
                    properties: {
                        skills: { type: Type.ARRAY, items: { type: Type.STRING } },
                        keywords: { type: Type.ARRAY, items: { type: Type.STRING } },
                        projects: { type: Type.ARRAY, items: { type: Type.STRING } },
                    },
                },
                rewrittenContent: {
                    type: Type.OBJECT,
                    properties: {
                        summary: { type: Type.STRING },
                        experience: { 
                            type: Type.ARRAY,
                            items: {
                              type: Type.OBJECT,
                              properties: {
                                  original: { type: Type.STRING, description: "Mô tả kinh nghiệm gốc, giữ nguyên để đối chiếu." },
                                  rewritten: { type: Type.STRING, description: "Mô tả kinh nghiệm đã được viết lại, tập trung vào thành tích." },
                              },
                              required: ["original", "rewritten"]
                            },
                        },
                    },
                },
            },
        };

        const fullAnalysisSchema = {
            type: Type.OBJECT,
            properties: {
                extractedCv: cvDataSchema,
                analysis: analysisSchema,
            },
            required: ["extractedCv", "analysis"]
        };

        async function analyzeCVImage(imageBase64, mimeType, targetJob) {
            const model = 'gemini-2.5-flash';
            const systemInstruction = `Bạn là một chuyên gia tuyển dụng và trợ lý AI thông minh, nói tiếng Việt. Nhiệm vụ của bạn là:
1.  **Trích xuất thông tin** từ hình ảnh CV được cung cấp. Điền tất cả thông tin bạn tìm thấy vào đối tượng JSON 'extractedCv'. Nếu không tìm thấy thông tin cho một trường nào đó, hãy để nó là một chuỗi trống (ví dụ: "").
2.  **Phân tích CV** dựa trên thông tin vừa trích xuất. Cung cấp phân tích chi tiết, đề xuất cải thiện, và viết lại nội dung để phù hợp với vị trí mục tiêu. Điền kết quả phân tích vào đối tượng JSON 'analysis'.
3.  Khi viết lại kinh nghiệm, hãy sử dụng các động từ mạnh, định lượng hóa kết quả và nhấn mạnh thành tích thay vì chỉ mô tả công việc.
4.  Luôn trả về một đối tượng JSON duy nhất, hợp lệ theo đúng schema đã định nghĩa.`;

            const prompt = `Vui lòng trích xuất và phân tích CV trong hình ảnh cho vị trí mục tiêu: "${targetJob}".`;

            const imagePart = { inlineData: { mimeType, data: imageBase64 } };
            const textPart = { text: prompt };

            try {
                const response = await ai.models.generateContent({
                    model: model,
                    contents: { parts: [imagePart, textPart] },
                    config: {
                        systemInstruction: systemInstruction,
                        responseMimeType: "application/json",
                        responseSchema: fullAnalysisSchema,
                        temperature: 0.3,
                    },
                });
                
                const jsonText = response.text.trim();
                const result = JSON.parse(jsonText);
                
                if (!result.extractedCv || !result.analysis) {
                    throw new Error("Phản hồi từ AI không có định dạng như mong đợi.");
                }
                return result;

            } catch (error) {
                console.error("Lỗi khi gọi Gemini API:", error);
                throw new Error("Không thể phân tích hình ảnh CV. Vui lòng thử lại với hình ảnh rõ nét hơn hoặc kiểm tra API key.");
            }
        }

        // --- RENDER FUNCTIONS ---
        function renderCVEditor() {
          if (!state.cvData) return;
          const { fullName, email, phone, linkedin, summary, experience, education, skills } = state.cvData;
          DOMElements.cvEditor.innerHTML = `
              <div class="space-y-6">
                <div>
                  <h2 class="text-xl font-bold text-gray-900">Thông tin CV của bạn</h2>
                  <p class="mt-1 text-sm text-gray-500">Đây là thông tin AI trích xuất được. Bạn có thể chỉnh sửa nếu cần.</p>
                </div>

                <div class="space-y-4 p-4 border-l-4 border-blue-500 bg-blue-50 rounded-r-lg">
                  <label for="targetJobEditor" class="block text-sm font-medium text-gray-800">Vị trí công việc mục tiêu</label>
                  <input type="text" id="targetJobEditor" value="${state.targetJob}" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 font-semibold" placeholder="VD: Kỹ sư phần mềm" />
                </div>
                
                <div class="space-y-4 border rounded-lg p-4">
                    <h3 class="font-semibold text-lg flex items-center gap-2 text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-blue-600"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="10" r="3"></circle><path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662"></path></svg>Thông tin cá nhân</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-700">Họ và tên</label><input data-field="fullName" type="text" value="${fullName}" class="cv-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm sm:text-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Email</label><input data-field="email" type="text" value="${email}" class="cv-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm sm:text-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700">Số điện thoại</label><input data-field="phone" type="text" value="${phone}" class="cv-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm sm:text-sm"></div>
                        <div><label class="block text-sm font-medium text-gray-700">LinkedIn</label><input data-field="linkedin" type="text" value="${linkedin}" class="cv-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm sm:text-sm"></div>
                    </div>
                    <div><label class="block text-sm font-medium text-gray-700">Tóm tắt bản thân</label><textarea data-field="summary" rows="4" class="cv-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm sm:text-sm">${summary}</textarea></div>
                </div>

                <div class="space-y-4 border rounded-lg p-4">
                    <h3 class="font-semibold text-lg flex items-center gap-2 text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-blue-600"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>Kinh nghiệm làm việc</h3>
                    <div id="experience-list" class="space-y-4">
                      ${experience.map((exp, index) => `
                        <div key="${index}" class="space-y-3 p-4 border rounded-md relative bg-gray-50">
                           <button data-index="${index}" class="remove-experience-btn absolute top-2 right-2 text-gray-400 hover:text-red-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 pointer-events-none"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><path d="M10 11v6"></path><path d="M14 11v6"></path></svg></button>
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div><label class="block text-sm font-medium text-gray-700">Tên công ty</label><input data-index="${index}" data-field="company" type="text" value="${exp.company}" class="cv-experience-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm sm:text-sm"></div>
                             <div><label class="block text-sm font-medium text-gray-700">Chức danh</label><input data-index="${index}" data-field="title" type="text" value="${exp.title}" class="cv-experience-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm sm:text-sm"></div>
                          </div>
                          <div><label class="block text-sm font-medium text-gray-700">Mô tả công việc</label><textarea data-index="${index}" data-field="description" rows="5" class="cv-experience-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm sm:text-sm">${exp.description}</textarea></div>
                        </div>
                      `).join('')}
                    </div>
                    <button id="add-experience-btn" class="text-sm font-medium text-blue-600 hover:text-blue-800">+ Thêm kinh nghiệm</button>
                </div>

                <div class="space-y-4 border rounded-lg p-4">
                   <h3 class="font-semibold text-lg flex items-center gap-2 text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-blue-600"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path></svg>Học vấn</h3>
                   <div><label class="block text-sm font-medium text-gray-700">Trường, chuyên ngành, bằng cấp</label><textarea data-field="education" rows="2" class="cv-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm sm:text-sm">${education}</textarea></div>
                </div>

                <div class="space-y-4 border rounded-lg p-4">
                   <h3 class="font-semibold text-lg flex items-center gap-2 text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-blue-600"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"></path><path d="M9 18h6"></path><path d="M10 22h4"></path></svg>Kỹ năng</h3>
                   <div><label class="block text-sm font-medium text-gray-700">Liệt kê các kỹ năng (cách nhau bởi dấu phẩy)</label><textarea data-field="skills" rows="3" class="cv-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm sm:text-sm">${skills}</textarea></div>
                </div>
              </div>
          `;
          document.getElementById('targetJobEditor').addEventListener('input', e => { state.targetJob = e.target.value; });
          document.getElementById('add-experience-btn').addEventListener('click', handleAddExperience);
        }
        
        function renderCVPreview() {
            if (!state.cvData) return;
            const { fullName, email, phone, linkedin, summary, experience, education, skills } = state.cvData;
            DOMElements.cvPreviewContainer.innerHTML = `
                <div class="text-center pb-6 border-b-2 border-gray-200">
                    <h1 class="text-3xl font-bold text-gray-900">${fullName || 'Họ và Tên'}</h1>
                    <div class="mt-4 flex flex-wrap justify-center items-center gap-x-6 gap-y-2 text-sm text-gray-600">
                        ${email ? `<p class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-blue-600"><rect width="20" height="16" x="2" y="4" rx="2"></rect><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path></svg> ${email}</p>` : ''}
                        ${phone ? `<p class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-blue-600"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg> ${phone}</p>` : ''}
                        ${linkedin ? `<p class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-blue-600"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg> ${linkedin}</p>` : ''}
                    </div>
                </div>
                <div class="mt-6">
                    <h2 class="text-xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-3">Tóm tắt bản thân</h2>
                    <p class="text-sm text-gray-700 leading-relaxed">${summary}</p>
                </div>
                <div class="mt-6">
                    <h2 class="text-xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-4">Kinh nghiệm làm việc</h2>
                    <div class="space-y-5">
                        ${experience.map(exp => `
                            <div class="flex gap-4">
                                <div class="mt-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-blue-500"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg></div>
                                <div>
                                    <h3 class="font-semibold text-md text-gray-800">${exp.title}</h3>
                                    <p class="text-sm font-medium text-gray-600">${exp.company}</p>
                                    <ul class="list-disc list-inside mt-2 text-sm text-gray-700 leading-relaxed space-y-1">
                                        ${exp.description.split(/[\.|\n]/).filter(d => d.trim()).map(point => `<li>${point.trim()}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="mt-6">
                    <h2 class="text-xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-3">Học vấn</h2>
                    <div class="flex gap-4">
                        <div class="mt-1"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-blue-500"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path></svg></div>
                        <p class="text-sm text-gray-700">${education}</p>
                    </div>
                </div>
                <div class="mt-6">
                    <h2 class="text-xl font-bold text-blue-700 border-b-2 border-blue-200 pb-2 mb-3">Kỹ năng</h2>
                    <div class="flex flex-wrap gap-2">
                        ${skills.split(',').map(skill => `<span class="bg-blue-100 text-blue-800 text-xs font-medium px-3 py-1 rounded-full">${skill.trim()}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        function renderAnalysisResult() {
            if (state.isLoading) {
                DOMElements.analysisResultContainer.innerHTML = `
                  <div class="flex flex-col items-center justify-center h-full text-center p-8">
                    <svg class="animate-spin w-16 h-16 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="mt-4 text-lg font-semibold text-gray-700">AI đang phân tích CV của bạn...</p>
                    <p class="text-gray-500">Quá trình này có thể mất vài giây. Vui lòng chờ.</p>
                  </div>`;
                return;
            }
             if (state.error) {
                DOMElements.analysisResultContainer.innerHTML = `
                  <div class="flex flex-col items-center justify-center h-full text-center p-8 bg-red-50 border border-red-200 rounded-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-16 h-16 text-red-500"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    <p class="mt-4 text-lg font-semibold text-red-700">Lỗi Phân Tích</p>
                    <p class="text-red-600">${state.error}</p>
                  </div>`;
                  return;
            }
            if (!state.analysisResult) {
                DOMElements.analysisResultContainer.innerHTML = `
                   <div class="flex flex-col items-center justify-center h-full text-center p-8">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-16 h-16 text-gray-400"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="m9 15 2 2 4-4"></path></svg>
                     <p class="mt-4 text-lg font-semibold text-gray-700">Chưa có phân tích</p>
                     <p class="text-gray-500">Nhấn "Phân tích lại" để nhận đánh giá từ AI.</p>
                   </div>
                `;
                return;
            }

            const { generalAnalysis, detailedCorrections, enhancementSuggestions, rewrittenContent } = state.analysisResult;
            DOMElements.analysisResultContainer.innerHTML = `
                <div class="space-y-8">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7 text-blue-600"><path d="M12 3L9.5 8.5L4 11L9.5 13.5L12 19L14.5 13.5L20 11L14.5 8.5L12 3Z"></path><path d="M5 3v4"></path><path d="M19 3v4"></path><path d="M3 5h4"></path><path d="M17 5h4"></path><path d="M5 21v-4"></path><path d="M19 21v-4"></path><path d="M3 19h4"></path><path d="M17 19h4"></path></svg>Kết quả phân tích từ AI</h2>
                        <button id="apply-suggestions-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Áp dụng đề xuất</button>
                    </div>
                    
                    <div class="space-y-4">
                        <h3 class="font-semibold text-lg flex items-center gap-2 text-gray-800">Phân tích tổng quan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <h4 class="font-semibold text-green-800">Điểm mạnh</h4>
                                <ul class="list-disc list-inside mt-2 text-sm text-green-700 space-y-1">${generalAnalysis.strengths.map(item => `<li>${item}</li>`).join('')}</ul>
                            </div>
                             <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                <h4 class="font-semibold text-yellow-800">Điểm cần cải thiện</h4>
                                <ul class="list-disc list-inside mt-2 text-sm text-yellow-700 space-y-1">${generalAnalysis.weaknesses.map(item => `<li>${item}</li>`).join('')}</ul>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="font-semibold text-lg flex items-center gap-2 text-gray-800">Viết lại nội dung</h3>
                        <div class="space-y-3 bg-gray-50 p-4 rounded-lg border">
                             <h4 class="font-semibold">Tóm tắt bản thân (đã tối ưu)</h4>
                             <p class="text-sm text-gray-700 italic border-l-4 border-blue-400 pl-4">${rewrittenContent.summary}</p>
                        </div>
                         <div class="space-y-3 bg-gray-50 p-4 rounded-lg border">
                             <h4 class="font-semibold">Kinh nghiệm làm việc (đã tối ưu)</h4>
                             ${rewrittenContent.experience.map(exp => `
                                 <div class="pt-2">
                                     <p class="text-sm text-gray-500 line-through">Gốc: ${exp.original}</p>
                                     <p class="text-sm text-gray-800 mt-1 italic border-l-4 border-blue-400 pl-4">${exp.rewritten}</p>
                                 </div>
                             `).join('')}
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="font-semibold text-lg flex items-center gap-2 text-gray-800">Đề xuất bổ sung</h3>
                         <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <p class="text-sm text-blue-700">Để phù hợp hơn với vị trí ứng tuyển, hãy cân nhắc thêm các mục sau vào CV:</p>
                            <div class="mt-3"><h4 class="font-semibold text-blue-800">Kỹ năng:</h4><p class="text-sm text-blue-700">${enhancementSuggestions.skills.join(', ')}</p></div>
                             <div class="mt-3"><h4 class="font-semibold text-blue-800">Từ khóa:</h4><p class="text-sm text-blue-700">${enhancementSuggestions.keywords.join(', ')}</p></div>
                             <div class="mt-3"><h4 class="font-semibold text-blue-800">Dự án:</h4><ul class="list-disc list-inside mt-1 text-sm text-blue-700 space-y-1">${enhancementSuggestions.projects.map(item => `<li>${item}</li>`).join('')}</ul></div>
                        </div>
                    </div>

                     <div class="space-y-4">
                        <h3 class="font-semibold text-lg flex items-center gap-2 text-gray-800">Chỉnh sửa chi tiết</h3>
                        ${detailedCorrections.map(item => `
                            <div class="p-3 bg-gray-50 rounded-lg border">
                                <p class="text-sm text-red-600 line-through">Gốc: ${item.original}</p>
                                <p class="text-sm text-green-700 mt-1">Đề xuất: ${item.suggestion}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('apply-suggestions-btn').addEventListener('click', handleApplySuggestions);
        }

        function updateUI() {
            // Loading state for analyze button
            if (state.isLoading) {
                DOMElements.analyzeButton.disabled = true;
                DOMElements.analyzeButtonLoading.classList.remove('hidden');
                DOMElements.analyzeButtonText.classList.add('hidden');
            } else {
                DOMElements.analyzeButton.disabled = !state.cvImage.file;
                DOMElements.analyzeButtonLoading.classList.add('hidden');
                DOMElements.analyzeButtonText.classList.remove('hidden');
            }
            // Loading state for re-analyze button
            if (state.isLoading) {
                 DOMElements.reanalyzeButton.disabled = true;
                 DOMElements.reanalyzeButtonLoading.classList.remove('hidden');
                 DOMElements.reanalyzeButtonText.classList.add('hidden');
            } else {
                 DOMElements.reanalyzeButton.disabled = false;
                 DOMElements.reanalyzeButtonLoading.classList.add('hidden');
                 DOMElements.reanalyzeButtonText.classList.remove('hidden');
            }

            // Error message
            if (state.error) {
                DOMElements.errorMessage.textContent = state.error;
                DOMElements.errorMessage.classList.remove('hidden');
            } else {
                DOMElements.errorMessage.classList.add('hidden');
            }

            // Image preview
            if (state.cvImage.preview) {
                DOMElements.imagePreview.src = state.cvImage.preview;
                DOMElements.imagePreviewWrapper.classList.remove('hidden');
                DOMElements.dropZone.classList.add('hidden');
                DOMElements.analyzeButton.disabled = state.isLoading;
            } else {
                DOMElements.imagePreview.src = '';
                DOMElements.imagePreviewWrapper.classList.add('hidden');
                DOMElements.dropZone.classList.remove('hidden');
                DOMElements.analyzeButton.disabled = true;
            }

            // View switching
            if (state.cvData) {
                DOMElements.uploadView.classList.add('hidden');
                DOMElements.mainView.classList.remove('hidden');
                DOMElements.mainView.classList.add('grid');
                renderCVEditor();
                renderCVPreview();
                renderAnalysisResult();
                updateTabs();
            } else {
                DOMElements.uploadView.classList.remove('hidden');
                DOMElements.mainView.classList.add('hidden');
                DOMElements.mainView.classList.remove('grid');
            }
        }
        
        function updateTabs() {
            if (state.activeTab === 'preview') {
                DOMElements.previewTab.classList.add('bg-white', 'text-blue-600', 'shadow');
                DOMElements.previewTab.classList.remove('text-gray-600', 'hover:bg-gray-300');
                DOMElements.analysisTab.classList.remove('bg-white', 'text-blue-600', 'shadow');
                DOMElements.analysisTab.classList.add('text-gray-600', 'hover:bg-gray-300');
                
                DOMElements.cvPreviewContainer.classList.remove('hidden');
                DOMElements.analysisResultContainer.classList.add('hidden');
            } else { // analysis tab
                DOMElements.analysisTab.classList.add('bg-white', 'text-blue-600', 'shadow');
                DOMElements.analysisTab.classList.remove('text-gray-600', 'hover:bg-gray-300');
                DOMElements.previewTab.classList.remove('bg-white', 'text-blue-600', 'shadow');
                DOMElements.previewTab.classList.add('text-gray-600', 'hover:bg-gray-300');

                DOMElements.cvPreviewContainer.classList.add('hidden');
                DOMElements.analysisResultContainer.classList.remove('hidden');
            }
        }


        // --- EVENT HANDLERS ---
        function handleFileSelect(file) {
            if (!file || !file.type.startsWith('image/')) {
                state.error = 'Vui lòng chỉ tải lên tệp hình ảnh (JPEG, PNG, v.v.).';
                updateUI();
                return;
            }
            const reader = new FileReader();
            reader.onloadend = () => {
                state.cvImage.file = file;
                state.cvImage.preview = reader.result;
                state.error = null;
                updateUI();
            };
            reader.readAsDataURL(file);
        }

        async function handleAnalyze() {
            if (!state.cvImage.file) {
                state.error = 'Vui lòng tải lên ảnh CV của bạn.';
                updateUI();
                return;
            }
            state.isLoading = true;
            state.error = null;
            state.analysisResult = null; // Clear previous results
            if (state.cvData) state.activeTab = 'analysis'; // Switch to analysis tab if already in main view
            updateUI();
            if (state.activeTab === 'analysis') renderAnalysisResult(); // Show loader in analysis pane

            try {
                const base64String = state.cvImage.preview.split(',')[1];
                const result = await analyzeCVImage(base64String, state.cvImage.file.type, state.targetJob);
                state.analysisResult = result.analysis;
                state.cvData = result.extractedCv;
                if (!state.cvData.experience) state.cvData.experience = []; // Ensure experience is an array
                
                // After successful analysis, switch to analysis tab
                state.activeTab = 'analysis';

            } catch (e) {
                state.error = e.message;
                // On critical error during initial analysis, reset the view
                if (!state.cvData) {
                    state.cvData = null;
                    state.cvImage = { file: null, preview: null };
                }
            } finally {
                state.isLoading = false;
                updateUI();
            }
        }
        
        function handleAddExperience() {
          state.cvData.experience.push({ company: '', title: '', description: '' });
          renderCVEditor();
        }

        function handleRemoveExperience(index) {
          state.cvData.experience.splice(index, 1);
          renderCVEditor();
          renderCVPreview();
        }

        function handleApplySuggestions() {
            if (!state.analysisResult || !state.analysisResult.rewrittenContent || !state.cvData) return;
            const { summary, experience: rewrittenExps } = state.analysisResult.rewrittenContent;

            const updatedExperience = state.cvData.experience.map((exp) => {
                const rewrittenExp = rewrittenExps.find(r => r.original && r.original.trim().includes(exp.description.trim()));
                return rewrittenExp ? { ...exp, description: rewrittenExp.rewritten } : exp;
            });

            state.cvData.summary = summary || state.cvData.summary;
            state.cvData.experience = updatedExperience;
            
            state.activeTab = 'preview';
            updateUI();
        }

        function handleCVDataUpdate(e) {
            const { field, index } = e.target.dataset;
            if (e.target.classList.contains('cv-input')) {
                state.cvData[field] = e.target.value;
            } else if (e.target.classList.contains('cv-experience-input')) {
                state.cvData.experience[index][field] = e.target.value;
            }
            renderCVPreview();
        }
        
        function handleRemoveImage() {
            state.cvImage = { file: null, preview: null };
            DOMElements.fileInput.value = '';
            updateUI();
        }
        

        // --- INITIALIZATION ---
        function init() {
            // Initial render
            DOMElements.targetJobInput.value = state.targetJob;
            updateUI();

            // Event Listeners
            DOMElements.targetJobInput.addEventListener('change', e => { state.targetJob = e.target.value; });
            DOMElements.analyzeButton.addEventListener('click', handleAnalyze);
            DOMElements.reanalyzeButton.addEventListener('click', handleAnalyze);

            DOMElements.dropZone.addEventListener('click', () => DOMElements.fileInput.click());
            DOMElements.fileInput.addEventListener('change', e => handleFileSelect(e.target.files[0]));
            DOMElements.removeImageButton.addEventListener('click', handleRemoveImage);

            // Drag and Drop
            const dropZone = DOMElements.dropZone;
            dropZone.addEventListener('dragenter', e => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('border-blue-500', 'bg-blue-50'); });
            dropZone.addEventListener('dragleave', e => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('border-blue-500', 'bg-blue-50'); });
            dropZone.addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); });
            dropZone.addEventListener('drop', e => {
                e.preventDefault();
                e.stopPropagation();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                handleFileSelect(e.dataTransfer.files[0]);
            });

            // Tabs
            DOMElements.previewTab.addEventListener('click', () => {
                state.activeTab = 'preview';
                updateTabs();
            });
            DOMElements.analysisTab.addEventListener('click', () => {
                state.activeTab = 'analysis';
                updateTabs();
            });

            // Event delegation for dynamic content in editor
            DOMElements.cvEditor.addEventListener('input', e => {
                if (e.target.classList.contains('cv-input') || e.target.classList.contains('cv-experience-input')) {
                    handleCVDataUpdate(e);
                }
            });
            DOMElements.cvEditor.addEventListener('click', e => {
                if (e.target.classList.contains('remove-experience-btn')) {
                    handleRemoveExperience(parseInt(e.target.dataset.index, 10));
                }
            });
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
 
